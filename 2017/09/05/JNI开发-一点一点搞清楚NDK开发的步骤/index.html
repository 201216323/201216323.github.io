<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>JNI开发----一点一点搞清楚NDK开发的步骤 | 常灿光个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JNI开发----一点一点搞清楚NDK开发的步骤</h1><a id="logo" href="/.">常灿光个人博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JNI开发----一点一点搞清楚NDK开发的步骤</h1><div class="post-meta">Sep 5, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h1 id="NDK开发流程"><a href="#NDK开发流程" class="headerlink" title="NDK开发流程"></a>NDK开发流程</h1><p>不同版本的Android Studio可能对于NDK的配置是不一样的，本文记录我在AS2.2.2版本上的配置过程。</p>
<h2 id="步骤1：安装配置NDK"><a href="#步骤1：安装配置NDK" class="headerlink" title="步骤1：安装配置NDK"></a>步骤1：安装配置NDK</h2><p>（1）打开AS的Project Structure目录，如下:</p>
<p><img src="http://ww2.sinaimg.cn/mw690/b0d9a523jw1fbg2m80dcaj20s00bz41j.jpg" alt="image"></p>
<p>点击Android NDK location 下方的Download来下载NDK，下载好的NDK会自动安装在SDK的目录里面。</p>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fbg2m87vkkj20lz0hfgns.jpg" alt="image"></p>
<p>（2）配置path环境变量，将NDK的根目录配置到环境变量的path里面，如下是我的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">C:\AndroidDevelop\sdk\ndk-bundle</div></pre></td></tr></table></figure>
<h2 id="步骤2：给AS配置关联NDK"><a href="#步骤2：给AS配置关联NDK" class="headerlink" title="步骤2：给AS配置关联NDK"></a>步骤2：给AS配置关联NDK</h2><p>（1）在项目的local.properties中添加配置ndk的根目录，默认情况下，经过步骤1的配置已经在local.properties中添加了ndk的根目录，如果没有手动添加，下面是我的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ndk.dir=C\:\\AndroidDevelop\\sdk\\ndk-bundle</div></pre></td></tr></table></figure>
<p>（2）gradle.properties中添加配置，目的是兼容老的NDK。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android.useDeprecatedNdk=true</div></pre></td></tr></table></figure>
<h2 id="步骤3：编写native方法"><a href="#步骤3：编写native方法" class="headerlink" title="步骤3：编写native方法"></a>步骤3：编写native方法</h2><p>我是在新建的类JniKit中创建的native方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class JniKit &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 定义native方法</div><div class="line">     * 调用C代码对应的方法</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native String sayHello();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="步骤4：定义对应的JNI"><a href="#步骤4：定义对应的JNI" class="headerlink" title="步骤4：定义对应的JNI"></a>步骤4：定义对应的JNI</h2><p>（1）通过命令行，生成native方法对应的JNI函数声明头文件: </p>
<p>在控制台或者Android studio自带的控制台使用javah -jni的命令，利用class文件生成.h头文件，这里要注意  javah -jni 在使用时有可能会出问题，比如找不到app.activity   找不到类文件，最后总结出来的就是严格按照以下来写：</p>
<p><img src="http://ww1.sinaimg.cn/mw690/b0d9a523jw1fbg40xzk0lj20qr0750vk.jpg" alt="image"></p>
<p>（2）在项目jni文件夹下创建一个对应的函数文件：Hello.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#include &lt;com_bruce_chang_testndk_JniKit.h&gt;</div><div class="line"></div><div class="line">JNIEXPORT jstring JNICALL Java_com_bruce_chang_testndk_JniKit_sayHello</div><div class="line">(JNIEnv *env, jobject jobj) &#123;</div><div class="line">    return (*env)-&gt;NewStringUTF(env, &quot;Hello from C&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>（3）在jni文件夹下创建一个空的C文件: empty.c。说明: 这是AS的bug, 必须至少2个C文件才能通过编译。</p>
<h2 id="步骤5：指定编译的不同CPU。"><a href="#步骤5：指定编译的不同CPU。" class="headerlink" title="步骤5：指定编译的不同CPU。"></a>步骤5：指定编译的不同CPU。</h2><p>在app的build.gradle的defaultConfig下添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line">        ndk&#123;</div><div class="line">            moduleName &quot;Hello&quot; //so文件: lib+moduleName+.so</div><div class="line">            abiFilters &quot;armeabi&quot;, &quot;armeabi-v7a&quot;, &quot;x86&quot; //cpu的类型</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="步骤6：编译生成不同平台下的动态链接文件"><a href="#步骤6：编译生成不同平台下的动态链接文件" class="headerlink" title="步骤6：编译生成不同平台下的动态链接文件"></a>步骤6：编译生成不同平台下的动态链接文件</h2><p>（1）执行rebuild, 生成so文件</p>
<p>（2）so文件目录: build\intermediates\ndk\debug\lib.….</p>
<h2 id="步骤7：调用native方法"><a href="#步骤7：调用native方法" class="headerlink" title="步骤7：调用native方法"></a>步骤7：调用native方法</h2><p>（1）在native方法所在的类JniKit.java中加载so文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">       System.loadLibrary(&quot;Hello&quot;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>（2）在Activity中调用native方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> String s = new JniKit().sayHello();</div><div class="line">tvNdk.setText(s);</div></pre></td></tr></table></figure>
<p>以上就是NDK从下载到本地配置，以及实现简单一个测试程序的过程。</p>
<blockquote>
<p>结果：显示C程序中返回的字符串”Hello from C”</p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/mw690/b0d9a523jw1fbg4le5zbbj209406p0su.jpg" alt="image"></p>
<blockquote>
<p>总结：使用NDK的大致开发流程主要包含下面几步</p>
</blockquote>
<ol>
<li>在java里面写native代码</li>
<li>在main目录下创建jni目录，写C代码，生成头文件</li>
<li>配置动态链接库的名称</li>
<li>加载动态链接库</li>
<li>代码具体调用</li>
</ol>
<blockquote>
<p>注意，使用c代码返回字符串类型的数据的时候，字符串类型是jstring，这里涉及到了java数据类型和C语言数据类型与本地JNI的一个对应关心，如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">java类型</th>
<th style="text-align:center">JNI别名</th>
<th style="text-align:center">C类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">boolean</td>
<td style="text-align:center">jboolean</td>
<td style="text-align:center">unsigned char</td>
</tr>
<tr>
<td style="text-align:center">byte</td>
<td style="text-align:center">jbyte</td>
<td style="text-align:center">signed char</td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">jchar</td>
<td style="text-align:center">unsigned char</td>
</tr>
<tr>
<td style="text-align:center">short</td>
<td style="text-align:center">jshort</td>
<td style="text-align:center">short</td>
</tr>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">jint</td>
<td style="text-align:center">int</td>
</tr>
<tr>
<td style="text-align:center">long</td>
<td style="text-align:center">jlong</td>
<td style="text-align:center">long long</td>
</tr>
<tr>
<td style="text-align:center">float</td>
<td style="text-align:center">jfloat</td>
<td style="text-align:center">float</td>
</tr>
<tr>
<td style="text-align:center">double</td>
<td style="text-align:center">jdouble</td>
<td style="text-align:center">double</td>
</tr>
</tbody>
</table>
<h1 id="详解NDK开发"><a href="#详解NDK开发" class="headerlink" title="详解NDK开发"></a>详解NDK开发</h1><h2 id="Java调用C函数"><a href="#Java调用C函数" class="headerlink" title="Java调用C函数"></a>Java调用C函数</h2><blockquote>
<p>重温一下生成头文件的方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E:\GithubDownload\TestNDK\javacallc\src\main&gt;javah -d jni -classpath C:\AndroidDevelop\sdk\platforms\android-25\android.jar;E:\GithubDownload\TestNDK\javacallc\build\intermediates\classes\debug bruce.chang.javacallc.Jni</div></pre></td></tr></table></figure>
<blockquote>
<p>下面四个小程序用到的java类</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public class Jni &#123;</div><div class="line"></div><div class="line">    static &#123;</div><div class="line">        System.loadLibrary(&quot;javacallc&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 求两个数字的和</div><div class="line">     *</div><div class="line">     * @param x</div><div class="line">     * @param y</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native int sum(int x, int y);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 将两个字符串拼接后返回</div><div class="line">     *</div><div class="line">     * @param s</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native String sayHello(String s);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 将数组中的每个元素增加10</div><div class="line">     *</div><div class="line">     * @param intArray</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native int[] increaseArrayEles(int[] intArray);</div><div class="line"></div><div class="line">    /**</div><div class="line">     *  应用: 检查密码是否正确, 如果正确返回200, 否则返回400</div><div class="line">     &quot;123456&quot;</div><div class="line">     * @param pwd</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native int checkPwd(String pwd);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试1：将传入的两个int值相加并返回"><a href="#测试1：将传入的两个int值相加并返回" class="headerlink" title="测试1：将传入的两个int值相加并返回"></a>测试1：将传入的两个int值相加并返回</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 求两个数字的和</div><div class="line">    *</div><div class="line">    * @param x</div><div class="line">    * @param y</div><div class="line">    * @return</div><div class="line">    */</div><div class="line">JNIEXPORT jint JNICALL Java_bruce_chang_javacallc_Jni_sum</div><div class="line">        (JNIEnv *env, jobject jobj, jint int1, jint int2) &#123;</div><div class="line">    //jint可以直接进行算术运算</div><div class="line">    int sum = int1 + int2;</div><div class="line">    //可直接将int类型数据作为jint返回</div><div class="line">    return sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试2：将两个字符串拼接后返回"><a href="#测试2：将两个字符串拼接后返回" class="headerlink" title="测试2：将两个字符串拼接后返回"></a>测试2：将两个字符串拼接后返回</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 将两个字符串拼接后返回</div><div class="line">     *</div><div class="line">     * @param s  I am BruceChang</div><div class="line">     *        c  I am SWJ</div><div class="line">     * @return  I am BruceChang add I am SWJ</div><div class="line">     */</div><div class="line">JNIEXPORT jstring JNICALL Java_bruce_chang_javacallc_Jni_sayHello</div><div class="line">        (JNIEnv * env, jobject jobj, jstring js)&#123;</div><div class="line">    //将jstring类型的js转换为char*类型数据</div><div class="line">    char * fromJava = _JString2CStr(env,js);</div><div class="line">    //c</div><div class="line">    char * fromC = &quot;add I am SWJ&quot;;</div><div class="line">    //将拼接两个char*类型字符串拼接在第一个上</div><div class="line">    strcat(fromJava, fromC);</div><div class="line">    //将结果转换为jstring类型返回</div><div class="line">    return (*env)-&gt;NewStringUTF(env, fromJava);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里面用到一个函数_JString2CStr 将字符串转换成字符指针</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * 工具函数</div><div class="line"> * 把一个jstring转换成一个c语言的char* 类型.</div><div class="line"> */</div><div class="line">char* _JString2CStr(JNIEnv* env, jstring jstr) &#123;</div><div class="line"></div><div class="line">    char* rtn;</div><div class="line">    jclass clsstring = (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;);</div><div class="line">    jstring strencode = (*env)-&gt;NewStringUTF(env,&quot;GB2312&quot;);</div><div class="line">    jmethodID mid = (*env)-&gt;GetMethodID(env, clsstring, &quot;getBytes&quot;, &quot;(Ljava/lang/String;)[B&quot;);</div><div class="line">    jbyteArray barr = (jbyteArray)(*env)-&gt;CallObjectMethod(env, jstr, mid, strencode); // String .getByte(&quot;GB2312&quot;);</div><div class="line">    jsize alen = (*env)-&gt;GetArrayLength(env, barr);</div><div class="line">    jbyte* ba = (*env)-&gt;GetByteArrayElements(env, barr, JNI_FALSE);</div><div class="line">    if(alen &gt; 0) &#123;</div><div class="line">        rtn = (char*)malloc(alen+1); //&quot;\0&quot;</div><div class="line">        memcpy(rtn, ba, alen);</div><div class="line">        rtn[alen]=0;</div><div class="line">    &#125;</div><div class="line">    (*env)-&gt;ReleaseByteArrayElements(env, barr, ba,0);</div><div class="line">    return rtn;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试3：将数组的每个元素增加10"><a href="#测试3：将数组的每个元素增加10" class="headerlink" title="测试3：将数组的每个元素增加10"></a>测试3：将数组的每个元素增加10</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 将数组中的每个元素增加10</div><div class="line">    *</div><div class="line">    * @param intArray</div><div class="line">    * @return</div><div class="line">    */</div><div class="line">JNIEXPORT jintArray JNICALL Java_bruce_chang_javacallc_Jni_increaseArrayEles</div><div class="line">        (JNIEnv * env, jobject jobj, jintArray arr)&#123;</div><div class="line"></div><div class="line">    //1. 得到数组的长度</div><div class="line">    //jsize       (*GetArrayLength)(JNIEnv*, jarray);</div><div class="line">    jsize length = (*env)-&gt;GetArrayLength(env, arr);</div><div class="line">    //2. 得到数组</div><div class="line">    //jint*       (*GetIntArrayElements)(JNIEnv*, jintArray, jboolean*);</div><div class="line">    jint* array = (*env)-&gt;GetIntArrayElements(env, arr, JNI_FALSE);</div><div class="line">    //3. 遍历数组, 并将每个元素+10</div><div class="line">    int i;</div><div class="line">    for(i=0;i&lt;length;i++) &#123;</div><div class="line">        *(array+i) += 10;</div><div class="line">    &#125;</div><div class="line">    //4. 返回数组</div><div class="line">    return arr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试4：检查密码是否正确"><a href="#测试4：检查密码是否正确" class="headerlink" title="测试4：检查密码是否正确"></a>测试4：检查密码是否正确</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  应用: 检查密码是否正确, 如果正确返回200, 否则返回400</div><div class="line"> &quot;123456&quot;</div><div class="line"> * @param pwd</div><div class="line"> * @return</div><div class="line"> */</div><div class="line">JNIEXPORT jint JNICALL Java_bruce_chang_javacallc_Jni_checkPwd</div><div class="line">        (JNIEnv * env, jobject jobj, jstring string)&#123;</div><div class="line">    //1. 将jString转换为char*</div><div class="line">    char* cs = _JString2CStr(env, string);</div><div class="line">    char* pwd = &quot;123456&quot;;</div><div class="line">    //2. 比较两个字符串是否相等</div><div class="line">    int result = strcmp(cs, pwd);</div><div class="line">    //3. 根据比较的结果返回不同的值</div><div class="line">    if(result==0) &#123;</div><div class="line">        return 200;</div><div class="line">    &#125;</div><div class="line">    return 400;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果：</p>
</blockquote>
<p><img src="http://wx2.sinaimg.cn/mw690/b0d9a523ly1fbqzs8a37pj209y08smx5.jpg" alt="image"></p>
<p>测试2，字符串的拼接，这个结果在不同的手机上显示效果还不太一样，在oppo r7上运行结果就是1、2、3、4、5，这个问题可能是程序不兼容导致的。</p>
<h2 id="C调用Java方法"><a href="#C调用Java方法" class="headerlink" title="C调用Java方法"></a>C调用Java方法</h2><p>C调用java方法和java调用C的方法步骤一样，但C回调java方法的核心思想是利用反射的原理，其次还需要用到java中的javap  -s命令来显示所有方法的签名信息，这个非常的重要，否则无法得到java类中的方法，从而也就无法实现C函数调用java方法。</p>
<blockquote>
<p>显示方法签名的命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">E:\&gt;cd E:\GithubDownload\TestNDK\ccalljava\src\main</div><div class="line"></div><div class="line">E:\GithubDownload\TestNDK\ccalljava\src\main&gt;javah -d jni -classpath C:\AndroidDevelop\sdk\platforms\android-23\android.jar;E:\GithubDownload\TestNDK\ccalljava\build\intermediates\classes\debug com.bruce.chang.ccalljava.Jni</div><div class="line"></div><div class="line">E:\GithubDownload\TestNDK\ccalljava\src\main&gt;javap -s -classpath C:\AndroidDevelop\sdk\platforms\android-23\android.jar;E:\GithubDownload\TestNDK\ccalljava\build\intermediates\classes\debug com.bruce.chang.ccalljava.Jni</div><div class="line">Compiled from &quot;Jni.java&quot;</div><div class="line">public class com.bruce.chang.ccalljava.Jni &#123;</div><div class="line">  public com.bruce.chang.ccalljava.Jni();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public native void callbackHelloFromJava();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public native void callbackAdd();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public native void callbackPrintString();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public native void callbackSayHello();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public void helloFromJava();</div><div class="line">    descriptor: ()V</div><div class="line"></div><div class="line">  public int add(int, int);</div><div class="line">    descriptor: (II)I</div><div class="line"></div><div class="line">  public void printString(java.lang.String);</div><div class="line">    descriptor: (Ljava/lang/String;)V</div><div class="line"></div><div class="line">  public static void sayHello(java.lang.String);</div><div class="line">    descriptor: (Ljava/lang/String;)V</div><div class="line"></div><div class="line">  static &#123;&#125;;</div><div class="line">    descriptor: ()V</div><div class="line">&#125;</div><div class="line"></div><div class="line">E:\GithubDownload\TestNDK\ccalljava\src\main&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>一般调用步骤</p>
</blockquote>
<ol>
<li>加载类得到class对象</li>
<li>得到对应方法的Method对象</li>
<li>创建类对象</li>
<li>调用方法</li>
</ol>
<h3 id="测试1：回调一般方法-无参无返回"><a href="#测试1：回调一般方法-无参无返回" class="headerlink" title="测试1：回调一般方法(无参无返回)"></a>测试1：回调一般方法(无参无返回)</h3><blockquote>
<p>java端方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public native void callbackHelloFromJava();</div></pre></td></tr></table></figure>
<blockquote>
<p>java端被回调方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void helloFromJava() &#123;</div><div class="line">     Log.e(&quot;TAG&quot;, &quot;helloFromJava()&quot;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>C端函数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">  void Java_com_bruce_chang_ccalljava_Jni_callbackHelloFromJava</div><div class="line">        (JNIEnv * env, jobject obj) &#123;</div><div class="line"></div><div class="line">    //1. 加载类得到jclass对象:</div><div class="line">    //jclass      (*FindClass)(JNIEnv*, const char*);</div><div class="line">    jclass jc = (*env)-&gt;FindClass(env, &quot;com/bruce/chang/ccalljava/Jni&quot;);</div><div class="line">    //2. 得到对应方法的Method对象 : GetMethodId()</div><div class="line">    //jmethodID   (*GetMethodID)(JNIEnv*, jclass, const char*, const char*)</div><div class="line">    jmethodID method = (*env)-&gt;GetMethodID(env, jc, &quot;helloFromJava&quot;, &quot;()V&quot;);</div><div class="line">    //3. 创建类对象</div><div class="line">    //jobject     (*AllocObject)(JNIEnv*, jclass);</div><div class="line">    jobject obj2 = (*env)-&gt;AllocObject(env, jc);</div><div class="line">    //4. 调用方法</div><div class="line">    (*env)-&gt;CallVoidMethod(env, obj2, method);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试2：回调带int参数方法"><a href="#测试2：回调带int参数方法" class="headerlink" title="测试2：回调带int参数方法"></a>测试2：回调带int参数方法</h3><blockquote>
<p>java端方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public native void callbackAdd();</div></pre></td></tr></table></figure>
<blockquote>
<p>java端被回调方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public int add(int x, int y) &#123;</div><div class="line">    Log.e(&quot;TAG&quot;, &quot;add() x=&quot; + x + &quot; y=&quot; + y);</div><div class="line">    return x + y;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>C端函数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> void  Java_com_bruce_chang_ccalljava_Jni_callbackAdd(JNIEnv * env, jobject obj)&#123;</div><div class="line">    //1. 加载类得到class对象</div><div class="line">    jclass jc = (*env)-&gt;FindClass(env, &quot;com/bruce/chang/ccalljava/Jni&quot;);</div><div class="line">    //2. 得到对应方法的Method对象</div><div class="line">    jmethodID method = (*env)-&gt;GetMethodID(env, jc, &quot;add&quot;, &quot;(II)I&quot;);</div><div class="line">    //3. 创建类对象</div><div class="line">    jobject obj2 = (*env)-&gt;AllocObject(env, jc);</div><div class="line">    //4. 调用方法</div><div class="line">    (*env)-&gt;CallIntMethod(env, obj2, method, 3, 4);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试3：回调带String参数方法"><a href="#测试3：回调带String参数方法" class="headerlink" title="测试3：回调带String参数方法"></a>测试3：回调带String参数方法</h3><blockquote>
<p>java端方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public native void callbackPrintString();</div></pre></td></tr></table></figure>
<blockquote>
<p>java端被回调方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void printString(String s) &#123;</div><div class="line">     Log.e(&quot;TAG&quot;, &quot;C中输入的：&quot; + s);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>C端函数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">  void  Java_com_bruce_chang_ccalljava_Jni_callbackPrintString(JNIEnv * env, jobject obj)&#123;</div><div class="line">    //1. 加载类得到class对象</div><div class="line">    jclass jc = (*env)-&gt;FindClass(env, &quot;com/bruce/chang/ccalljava/Jni&quot;);</div><div class="line">    //2. 得到对应方法的Method对象</div><div class="line">    jmethodID method = (*env)-&gt;GetMethodID(env, jc, &quot;printString&quot;, &quot;(Ljava/lang/String;)V&quot;);</div><div class="line">    //3. 创建类对象</div><div class="line">    jobject obj2 = (*env)-&gt;AllocObject(env, jc);</div><div class="line">    //4. 调用方法</div><div class="line">    jstring js = (*env)-&gt;NewStringUTF(env, &quot;I from C&quot;);</div><div class="line">    (*env)-&gt;CallVoidMethod(env, obj2, method, js);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试4：回调静态方法"><a href="#测试4：回调静态方法" class="headerlink" title="测试4：回调静态方法"></a>测试4：回调静态方法</h3><blockquote>
<p>java端方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public native void callbackSayHello();</div></pre></td></tr></table></figure>
<blockquote>
<p>java端被回调方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public static void sayHello(String s) &#123;</div><div class="line">     Log.e(&quot;TAG&quot;, &quot;我是java代码中的JNI.&quot;</div><div class="line">             + &quot;java中的sayHello(String s)静态方法，我被C调用了:&quot; + s);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>C端函数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">  void  Java_com_bruce_chang_ccalljava_Jni_callbackSayHello(JNIEnv * env, jobject obj)&#123;</div><div class="line">    //1. 加载类得到class对象</div><div class="line">    jclass jc = (*env)-&gt;FindClass(env, &quot;com/bruce/chang/ccalljava/Jni&quot;);</div><div class="line">    //2. 得到对应方法的Method对象</div><div class="line">    jmethodID method = (*env)-&gt;GetStaticMethodID(env, jc, &quot;sayHello&quot;, &quot;(Ljava/lang/String;)V&quot;);</div><div class="line">    //3. 调用方法</div><div class="line">    jstring js = (*env)-&gt;NewStringUTF(env, &quot;I from C&quot;);</div><div class="line">    (*env)-&gt;CallStaticVoidMethod(env, jc, method, js);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果：</p>
</blockquote>
<p><img src="http://wx4.sinaimg.cn/mw690/b0d9a523ly1fbr0iibw6cj20pt0a8dgm.jpg" alt="image"></p>
<h3 id="小应用：回调更新UI的方法"><a href="#小应用：回调更新UI的方法" class="headerlink" title="小应用：回调更新UI的方法"></a>小应用：回调更新UI的方法</h3><blockquote>
<p>java端方法，在MainActivity中写</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 让C代码调用MainActivity中的showToast方法</div><div class="line"> */</div><div class="line">public native void callbackShowToast();</div></pre></td></tr></table></figure>
<blockquote>
<p>java端被回调方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void showToast() &#123;</div><div class="line">    Toast.makeText(MainActivity.this, &quot;this is a toast!!!&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>C端函数</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> /**</div><div class="line"> * 让C代码调用MainActivity中的showToast方法</div><div class="line"> * obj  谁调用了当前Java_com_bruce_chang_ccalljava_Jni_callbackShowToast对应的java方法就是就是谁的实例，</div><div class="line"> * 该方法如果放在Jni这个类中就是是Jni.this，如果放在MainActivity中就是MainActivity.this</div><div class="line"> */</div><div class="line">void  Java_com_bruce_chang_ccalljava_MainActivity_callbackShowToast(JNIEnv * env, jobject obj)&#123;</div><div class="line">    //1. 加载类得到class对象</div><div class="line">    jclass jc = (*env)-&gt;FindClass(env, &quot;com/bruce/chang/ccalljava/MainActivity&quot;);</div><div class="line">    //2. 通过方法名和方法签名得到对应方法的Method对象</div><div class="line">    jmethodID method = (*env)-&gt;GetMethodID(env, jc, &quot;showToast&quot;, &quot;()V&quot;);</div><div class="line">    //3. 创建类对象</div><div class="line">   // jobject obj2 = (*env)-&gt;AllocObject(env, jc);</div><div class="line">    //4. 调用方法</div><div class="line">    (*env)-&gt;CallVoidMethod(env, obj, method);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>点击调用callbackShowToast方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// jni.callbackShowToast();不能调用jni中的callbackShowToast方法，这样会报空指针错误，因为发射得到的是MainActivity的类，</div><div class="line">// 并不是Activity，在执行showToast方法的时候就出错了</div><div class="line">MainActivity.this.callbackShowToast();</div></pre></td></tr></table></figure>
<blockquote>
<p>结果：</p>
</blockquote>
<p><img src="http://wx2.sinaimg.cn/mw690/b0d9a523ly1fbr1jjuxxlj209z0bq0si.jpg" alt="image"></p>
<blockquote>
<p>切记切记</p>
</blockquote>
<p>通过本实例可以发现，通过C代码调用活动中的方法的时候，一定要在活动中调用native方法，否则在C回调的时候就会出现空指针的错误。</p>
<h2 id="JNINativeInterface的相关函数指针"><a href="#JNINativeInterface的相关函数指针" class="headerlink" title="JNINativeInterface的相关函数指针"></a>JNINativeInterface的相关函数指针</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 加载类得到类对象</div><div class="line">//返回: jni的class类型</div><div class="line">jclass (*FindClass)(JNIEnv*, const char*)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//功能: 得到对应方法的Method对象</div><div class="line">jmethodID (*GetMethodID)(JNIEnv*, jclass, const char*, const char*)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//功能: 创建对象</div><div class="line">jobject (*AllocObject)(JNIEnv*, jclass)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//功能: 调用没有返回值的方法</div><div class="line">void (*CallVoidMethod)(JNIEnv*, jobject, jmethodID, ...)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//功能: 调用返回int值的方法</div><div class="line">jint (*CallIntMethod)(JNIEnv*, jobject, jmethodID, ...)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 得到静态方法的method</div><div class="line"></div><div class="line">jmethodID   (*GetStaticMethodID)(JNIEnv*, jclass, const char*, const char*)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//功能: 调用静态方法</div><div class="line">void (*CallStaticVoidMethod)(JNIEnv*, jclass, jmethodID, ...)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 将C中的字符串转换为JNI中的jstring类型</div><div class="line">//第二个: 被转换的字符串</div><div class="line">jstring (*NewStringUTF)(JNIEnv*, const char*)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 将第二个字符串连接到第一个字符串上</div><div class="line"></div><div class="line">string.h---char* strcat(char *, const char *);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 得到jni类型数组的长度(元素个数)</div><div class="line"></div><div class="line">jsize (*GetArrayLength)(JNIEnv*, jarray);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//功能: 得到jni数组中所有元素的指针</div><div class="line">//第二个: jni中的int数组   第三个: 是否返回一个复制的数组</div><div class="line">jint* (*GetIntArrayElements)(JNIEnv*, jintArray, jboolean*);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//参数为两个字符串</div><div class="line">//第一个与第二个相等, 返回0    第一个大于第二个, 返回大于0   第一个小于第二个, 返回小于0</div><div class="line">string.h---int strcmp(const char *, const char *)</div></pre></td></tr></table></figure>
<h1 id="NDK开发综合案例"><a href="#NDK开发综合案例" class="headerlink" title="NDK开发综合案例"></a>NDK开发综合案例</h1><h2 id="案例1：-美图秀秀"><a href="#案例1：-美图秀秀" class="headerlink" title="案例1： 美图秀秀"></a>案例1： 美图秀秀</h2><blockquote>
<p>步骤</p>
</blockquote>
<ol>
<li>创建工程MTXX</li>
<li>把对应的.so文件拷贝到java/main/jniLibs目录。。armeabi/libmtimage-jin.so</li>
<li>创建一个类叫做JNI.java并且要在com.mt.mtxx.image包下创建</li>
<li>加载动态链接库，System.loadLibrary(“mtimage-jni”)</li>
<li>写布局文件和实现各个效果的点击事件</li>
<li>处理图片相关的工作</li>
</ol>
<ul>
<li>6.1把图片转换成矩阵（数组）</li>
<li>6.2把数组传入给C代码处理</li>
<li>6.3把处理好的数组重新生成图片</li>
<li>6.4把图片显示</li>
</ul>
<p>按照上面的步骤一步一步的来，布局文件非常简单，就不写出来了。</p>
<blockquote>
<p>布局效果</p>
</blockquote>
<p><img src="http://wx3.sinaimg.cn/mw690/b0d9a523ly1fbr4ilttdbj209k0c1762.jpg" alt="image"></p>
<blockquote>
<p>java程序中调用处理</p>
</blockquote>
<ol>
<li>加载Jni程序</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">JNI jni = new JNI();</div></pre></td></tr></table></figure>
<ol>
<li>高亮效果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public void lomoHDR(View view) &#123;</div><div class="line"></div><div class="line">       //6.1，把图片转换成数组</div><div class="line">       Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.fbb);</div><div class="line">       //装图片的像数</div><div class="line">       int[] pixels = new int[bitmap.getWidth() * bitmap.getHeight()];</div><div class="line">       /**</div><div class="line">        * 参数</div><div class="line">        pixels       接收位图颜色值的数组</div><div class="line">        offset      写入到pixels[]中的第一个像素索引值</div><div class="line">        stride       pixels[]中的行间距个数值(必须大于等于位图宽度)。可以为负数</div><div class="line">        x             从位图中读取的第一个像素的x坐标值。</div><div class="line">        y             从位图中读取的第一个像素的y坐标值</div><div class="line">        width       从每一行中读取的像素宽度</div><div class="line">        height 　　读取的行数</div><div class="line">        　　异常</div><div class="line">        */</div><div class="line">       bitmap.getPixels(pixels, 0, bitmap.getWidth(), 0, 0, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">       //6.2,把数组传入给C代码处理</div><div class="line">       jni.StyleLomoHDR(pixels, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">       // 6.3，把处理好的数组重新生成图片</div><div class="line">       bitmap = Bitmap.createBitmap(pixels, bitmap.getWidth(), bitmap.getHeight(), Bitmap.Config.ARGB_8888);</div><div class="line">       // 6.4,把图片像数</div><div class="line">       iv_icon.setImageBitmap(bitmap);</div><div class="line"></div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>黑白效果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public void lomoC(View view) &#123;</div><div class="line"></div><div class="line">        //6.1，把图片转换成数组</div><div class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.fbb);</div><div class="line">        //装图片的像数</div><div class="line">        int[] pixels = new int[bitmap.getWidth() * bitmap.getHeight()];</div><div class="line">        bitmap.getPixels(pixels, 0, bitmap.getWidth(), 0, 0, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">        //6.2,把数组传入给C代码处理</div><div class="line">        jni.StyleLomoC(pixels, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">        // 6.3，把处理好的数组重新生成图片</div><div class="line">        bitmap = Bitmap.createBitmap(pixels, bitmap.getWidth(), bitmap.getHeight(), Bitmap.Config.ARGB_8888);</div><div class="line">        // 6.4,把图片像数</div><div class="line">        iv_icon.setImageBitmap(bitmap);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>怀旧效果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public void lomoB(View view) &#123;</div><div class="line">        //6.1，把图片转换成数组</div><div class="line">        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.mipmap.fbb);</div><div class="line">        //装图片的像数</div><div class="line">        int[] pixels = new int[bitmap.getWidth() * bitmap.getHeight()];</div><div class="line">        bitmap.getPixels(pixels, 0, bitmap.getWidth(), 0, 0, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">        //6.2,把数组传入给C代码处理</div><div class="line">        jni.StyleLomoB(pixels, bitmap.getWidth(), bitmap.getHeight());</div><div class="line">        // 6.3，把处理好的数组重新生成图片</div><div class="line">        bitmap = Bitmap.createBitmap(pixels, bitmap.getWidth(), bitmap.getHeight(), Bitmap.Config.ARGB_8888);</div><div class="line">        // 6.4,把图片像数</div><div class="line">        iv_icon.setImageBitmap(bitmap);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>还原</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iv_icon.setImageResource(R.mipmap.fbb);</div></pre></td></tr></table></figure>
<p>剩下的四种效果就不说明了，稍后看一下结果。</p>
<blockquote>
<p>结果(只能在arm架构的处理器上运行，x86的处理器的手机是不能运行该程序的)：</p>
</blockquote>
<p><img src="http://wx1.sinaimg.cn/mw690/b0d9a523ly1fbr4rinlhrg209i0fual7.gif" alt="image"></p>
<h2 id="案例2：-锅炉压力系统"><a href="#案例2：-锅炉压力系统" class="headerlink" title="案例2： 锅炉压力系统"></a>案例2： 锅炉压力系统</h2><blockquote>
<p>步骤</p>
</blockquote>
<ol>
<li>创建一个module名字叫做GuoLu，<br>1.1 在MainActivity中写得到锅炉压力值的native方法—getPressure()；<br>1.2 在build.gradle文件中配置生成.so文件的名称</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line">        applicationId &quot;com.bruce.chang.guolu&quot;</div><div class="line">        minSdkVersion 15</div><div class="line">        targetSdkVersion 25</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line"></div><div class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</div><div class="line">        ndk&#123;</div><div class="line">            moduleName &quot;GuoLu&quot; //so文件: lib+moduleName+.so</div><div class="line">            abiFilters &quot;armeabi&quot;, &quot;armeabi-v7a&quot;, &quot;x86&quot; //cpu的类型</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>分析实现的原理</li>
<li>在C代码中写锅炉的压力值，返回给java</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> 得到锅炉的压力值</div><div class="line">*/</div><div class="line">int pressure = 20;</div><div class="line">int getPressure()&#123;</div><div class="line">    int incease = rand()%20;</div><div class="line">    pressure += incease;</div><div class="line">    return pressure;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>在视图中动态绘制</li>
</ol>
<blockquote>
<p>GuoLu.c代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">// Created by Administrator on 2016/4/19.</div><div class="line">//</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;jni.h&gt;</div><div class="line">/**</div><div class="line"> 得到锅炉的压力值</div><div class="line">*/</div><div class="line">int pressure = 20;</div><div class="line">int getPressure()&#123;</div><div class="line">    int incease = rand()%20;</div><div class="line">    pressure += incease;</div><div class="line">    return pressure;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 从锅炉感应器中得到锅炉压力值</div><div class="line"> */</div><div class="line">jint  Java_com_bruce_chang_guolu_MainActivity_getPressure(JNIEnv *env, jobject instance) &#123;</div><div class="line">    int pressur = getPressure();</div><div class="line">    return pressur;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>MainActivity.java中调用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line">    &#123;</div><div class="line">        System.loadLibrary(&quot;GuoLu&quot;);</div><div class="line">    &#125;</div><div class="line">    PressureView pressureView;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        pressureView = new PressureView(MainActivity.this);</div><div class="line">        setContentView(pressureView);</div><div class="line">        new Thread(new Runnable() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                while (true) &#123;</div><div class="line">                    SystemClock.sleep(500);</div><div class="line">                    int pressure = Math.abs(getPressure());</div><div class="line">                    pressureView.setPressure(pressure);</div><div class="line">                    //如果压力大于220</div><div class="line">                    if (pressure &gt; 220) &#123;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * native代码</div><div class="line">     * 调用C代码中的对应方法</div><div class="line">     *</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public native int getPressure();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>自定义view—PressureView来控制显示的过程</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">public class PressureView extends View &#123;</div><div class="line">    private int pressure;</div><div class="line">    private Paint mPaint;</div><div class="line"></div><div class="line">    public PressureView(Context context) &#123;</div><div class="line">        super(context);</div><div class="line">        mPaint = new Paint();</div><div class="line">        mPaint.setAntiAlias(true);</div><div class="line">        mPaint.setTextSize(50);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPressure(int pressure) &#123;</div><div class="line">        this.pressure = pressure;</div><div class="line">//        invalidate();//在主线程中运行</div><div class="line">        postInvalidate();//ondraw()执行</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    @Override</div><div class="line">    protected void onDraw(Canvas canvas) &#123;</div><div class="line">        super.onDraw(canvas);</div><div class="line">        //1：如果压力值大于220，就绘制文本，显示锅炉爆炸了，快跑</div><div class="line">        if (pressure &gt; 220) &#123;</div><div class="line">            mPaint.setColor(Color.RED);</div><div class="line">            canvas.drawText(&quot;要爆炸了，快跑炮&quot;, 10, getHeight() / 2, mPaint);</div><div class="line">        &#125; else &#123;</div><div class="line">            //2：正常和提示的情况</div><div class="line">            //设置背景颜色为灰色</div><div class="line">            mPaint.setColor(Color.GRAY);</div><div class="line">            canvas.drawRect(10, 10, 60, 260, mPaint);</div><div class="line">            canvas.drawText(&quot;pressure==&quot;+pressure, 10, getHeight() / 2, mPaint);</div><div class="line">            //2.1  如果是小于200正常显示并且设置画笔颜色绿色</div><div class="line">            if (pressure &lt; 200) &#123;</div><div class="line">                mPaint.setColor(Color.GREEN);</div><div class="line">                canvas.drawRect(10, 260-pressure, 60, 260, mPaint);</div><div class="line">            &#125; else if (pressure&gt;200)&#123;</div><div class="line">                //2.2  如果是大于200警示显示给看护者，并且设置画笔颜色红色</div><div class="line">                mPaint.setColor(Color.YELLOW);</div><div class="line">                canvas.drawRect(10, 260-pressure, 60, 260, mPaint);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果（在x86的模拟器上运行）</p>
</blockquote>
<p><img src="http://wx1.sinaimg.cn/mw690/b0d9a523ly1fbrdnr7f8rg207s0f20u3.gif" alt="image"></p>
<p>以上就是自己对NDK的学习，以后工作中具体使用吧。</p>
<h1 id="源码下载地址"><a href="#源码下载地址" class="headerlink" title="源码下载地址"></a>源码下载地址</h1><p><a href="https://github.com/201216323/TestNDK" target="_blank" rel="external">https://github.com/201216323/TestNDK</a></p>
<blockquote>
<p>欢迎访问<a href="http://www.201216323.tech" target="_blank" rel="external">201216323.tech</a>来查看我的CSDN博客。</p>
<p>欢迎关注我的个人微信公众号,快速查看我的最新文章。</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20161220174646569?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2NnXzIwMTIxNjMyMw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="我的公众号图片" title="bruce常"></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://201216323.tech/2017/09/05/JNI开发-一点一点搞清楚NDK开发的步骤/" data-id="cj77mcaez0017acsgv9jmp0sy" class="article-share-link">分享</a><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a href="/2017/09/05/MVP设计模式的一次深入探索和优化/" class="pre">MVP设计模式的一次深入探索和优化</a><a href="/2017/09/05/JNI开发-复习曾经学习过的C语言/" class="next">JNI开发----复习曾经学习过的C语言</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://201216323.tech"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Html5/" style="font-size: 15px;">Html5</a> <a href="/tags/友盟/" style="font-size: 15px;">友盟</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/熟练使用Android-Studio，亲自体验，持续更新。/">熟练使用Android Studio，亲自体验，持续更新。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/MVP设计模式的一次深入探索和优化/">MVP设计模式的一次深入探索和优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-一点一点搞清楚NDK开发的步骤/">JNI开发----一点一点搞清楚NDK开发的步骤</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-复习曾经学习过的C语言/">JNI开发----复习曾经学习过的C语言</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/过去的2016，期待的2017，我与北京继续相伴。/">过去的2016，期待的2017，我与北京继续相伴。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/事件总线之EventBus/">事件总线之EventBus</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Fresco/">图片加载框架之Fresco</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Picasso/">图片加载框架之Picasso</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Glide/">图片加载框架之Glide</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/个人收藏的一些很有性价比的Github链接/">个人收藏的一些很有性价比的Github链接</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">常灿光个人博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>