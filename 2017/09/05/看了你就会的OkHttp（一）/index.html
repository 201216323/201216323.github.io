<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>看了你就会的OkHttp（一） | 常灿光个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">看了你就会的OkHttp（一）</h1><a id="logo" href="/.">常灿光个人博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">看了你就会的OkHttp（一）</h1><div class="post-meta">Sep 5, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h1 id="1：OKHttp介绍"><a href="#1：OKHttp介绍" class="headerlink" title="1：OKHttp介绍"></a>1：OKHttp介绍</h1><h2 id="1-1简介"><a href="#1-1简介" class="headerlink" title="1.1简介"></a>1.1简介</h2><p>OKHttp是一款高效的HTTP客户端，支持连接同一地址的链接共享同一个socket，通过连接池来减小响应延迟，还有透明的GZIP压缩，请求缓存等优势，其核心主要有<strong>路由</strong>、<strong>连接协议</strong>、<strong>拦截器</strong>、<strong>代理</strong>、<strong>安全性认证</strong>、<strong>连接池</strong>以及<strong>网络适配</strong>，拦截器主要是++指添加，移除或者转换请求或者回应头部信息++</p>
<p>这个库也是square开源的一个网络请求库(okhttp内部依赖okio)。现在已被Google使用在Android源码上了，可见其强大。</p>
<p>关于网络请求库，现在应该还有很多人在使用<strong>android-async-http</strong>。他内部使用的是HttpClient，但是Google在6.0版本里面删除了HttpClient相关API，可见这个库现在有点过时了。</p>
<p>OkHttp最低支持Android2.3，最低支持java1.7.</p>
<p>对于square这个公司还有许多优秀的开源项目，例如<strong>Retrofit</strong>、<strong>picasso</strong>等，这些随后都会详细的说明。</p>
<h2 id="1-2下载地址"><a href="#1-2下载地址" class="headerlink" title="1.2下载地址"></a>1.2下载地址</h2><p><a href="https://github.com/square/okhttp" target="_blank" rel="external">https://github.com/square/okhttp</a></p>
<h2 id="1-3OKHttp主要功能"><a href="#1-3OKHttp主要功能" class="headerlink" title="1.3OKHttp主要功能"></a>1.3OKHttp主要功能</h2><ol>
<li>联网请求文本数据</li>
<li>大文件下载</li>
<li>大文件上传</li>
<li>请求图片</li>
</ol>
<h1 id="2：原生OKHttp的Get和Post请求小案例"><a href="#2：原生OKHttp的Get和Post请求小案例" class="headerlink" title="2：原生OKHttp的Get和Post请求小案例"></a>2：原生OKHttp的Get和Post请求小案例</h1><h2 id="2-1使用前配置"><a href="#2-1使用前配置" class="headerlink" title="2.1使用前配置"></a>2.1使用前配置</h2><h3 id="2-1-1-参照网址："><a href="#2-1-1-参照网址：" class="headerlink" title="2.1.1 参照网址："></a>2.1.1 参照网址：</h3><p><a href="http://square.github.io/okhttp/" target="_blank" rel="external">http://square.github.io/okhttp/</a> 里面有对okhttp使用的描述，下面是里面主要的get和set方法。</p>
<h3 id="2-1-2-get-a-rul"><a href="#2-1-2-get-a-rul" class="headerlink" title="2.1.2 get a rul:"></a>2.1.2 get a rul:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">OkHttpClient client = new OkHttpClient();</div><div class="line"></div><div class="line">String run(String url) throws IOException &#123;</div><div class="line">  Request request = new Request.Builder()</div><div class="line">      .url(url)</div><div class="line">      .build();</div><div class="line"></div><div class="line">  Response response = client.newCall(request).execute();</div><div class="line">  return response.body().string();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1-3-post-to-a-server"><a href="#2-1-3-post-to-a-server" class="headerlink" title="2.1.3 post to a server"></a>2.1.3 post to a server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public static final MediaType JSON</div><div class="line">    = MediaType.parse(&quot;application/json; charset=utf-8&quot;);</div><div class="line"></div><div class="line">OkHttpClient client = new OkHttpClient();</div><div class="line"></div><div class="line">String post(String url, String json) throws IOException &#123;</div><div class="line">  RequestBody body = RequestBody.create(JSON, json);</div><div class="line">  Request request = new Request.Builder()</div><div class="line">      .url(url)</div><div class="line">      .post(body)</div><div class="line">      .build();</div><div class="line">  Response response = client.newCall(request).execute();</div><div class="line">  return response.body().string();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1-4-最新的jar包"><a href="#2-1-4-最新的jar包" class="headerlink" title="2.1.4 最新的jar包"></a>2.1.4 最新的jar包</h3><p>项目中要想使用OkHttp，有两种方法。</p>
<ol>
<li><p>导入OkHttp的jar包，因其内部依赖Okio，所以还需要导入okio的jar包，</p>
</li>
<li><p>可以直接在项目中添加gradle配置，compile ‘com.squareup.okhttp3:okhttp:(insert latest version)’</p>
</li>
<li>小编写此文章时候最新的OkHttp版本是okhttp-3.5.0，最新的okiio版本是okio-1.11.0。</li>
<li>将下载好的两个jar包导入到自己的项目中使用</li>
</ol>
<h2 id="2-2Get请求"><a href="#2-2Get请求" class="headerlink" title="2.2Get请求"></a>2.2Get请求</h2><h3 id="2-2-1布局"><a href="#2-2-1布局" class="headerlink" title="2.2.1布局"></a>2.2.1布局</h3><p>在项目布局activity_main.xml中添加发送get请求和post请求的按钮，并添加显示请求结果的textview，这里省略布局。。。最重要的别往了添加网络请求权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</div></pre></td></tr></table></figure>
<h3 id="2-2-2主程序"><a href="#2-2-2主程序" class="headerlink" title="2.2.2主程序"></a>2.2.2主程序</h3><p>在MainActivity.java中添加相应按钮的点击事件，在点击get按钮执行get请求，将请求成功的数据显示在textview上。</p>
<blockquote>
<p>从2.1.2中可以看到，首先需要new一个OkHttpClient供访问网络使用。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OkHttpClient client = new OkHttpClient();</div></pre></td></tr></table></figure>
<blockquote>
<p>get请求核心方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * get请求，要在子线程运行</div><div class="line">     *</div><div class="line">     * @param url 请求的地址</div><div class="line">     * @return</div><div class="line">     * @throws IOException</div><div class="line">     */</div><div class="line">    String okGet(String url) throws IOException &#123;</div><div class="line">        Request request = new Request.Builder()</div><div class="line">                .url(url)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        Response response = client.newCall(request).execute();</div><div class="line">        return response.body().string();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>点击get请求按钮调用下面方法来得到请求成功返回的json数据，因为网络的访问是一个耗时的操作，这个需要单独开一个线程，最后通过Handle机制来加载请求成功的结果。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private void getDataFromGet() &#123;</div><div class="line">        new Thread() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                super.run();</div><div class="line">                try &#123;</div><div class="line">                    String result = okGet(&quot;http://api.m.mtime.cn/PageSubArea/TrailerList.api&quot;);</div><div class="line">                    Message msg = new Message();</div><div class="line">                    msg.what = GET;</div><div class="line">                    msg.obj = result;</div><div class="line">                    mHandler.sendMessage(msg);</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Handler得到数据加载显示</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Handler mHandler = new Handler() &#123;</div><div class="line">        @Override</div><div class="line">        public void handleMessage(Message msg) &#123;</div><div class="line">            super.handleMessage(msg);</div><div class="line">            switch (msg.what) &#123;</div><div class="line">                case GET:</div><div class="line">                    tv_result.setText(msg.obj.toString());</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p>get请求结果</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/mw690/b0d9a523jw1fayhjcu0ddg20bx0mlqv5.gif" alt="get请求结果"></p>
<h2 id="2-3Post请求"><a href="#2-3Post请求" class="headerlink" title="2.3Post请求"></a>2.3Post请求</h2><p>从2.1.3中我们可以看到post请求的方法，拷贝上面的代码到MainActivity.java中，去掉再get请求中已经添加的OkHttpClient client = new OkHttpClient()，然后像get方法一样，在新的线程中进行请求调用，结果同样通过Handle消息机制发出并在textview上加载服务器返回的json数据。</p>
<blockquote>
<p>post请求核心方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * post请求，要在子线程运行</div><div class="line">     *</div><div class="line">     * @param url  请求链接</div><div class="line">     * @param json 参数</div><div class="line">     * @return</div><div class="line">     * @throws IOException</div><div class="line">     */</div><div class="line">    String okPost(String url, String json) throws IOException &#123;</div><div class="line">        MediaType JSON = MediaType.parse(&quot;application/json; charset=utf-8&quot;);</div><div class="line">        RequestBody body = RequestBody.create(JSON, json);</div><div class="line">        Request request = new Request.Builder()</div><div class="line">                .url(url)</div><div class="line">                .post(body)</div><div class="line">                .build();</div><div class="line">        Response response = client.newCall(request).execute();</div><div class="line">        return response.body().string();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>post按钮点击调用下面方法，okPost()方法的第二个参数是请求参数，这里没有参数，就传入空字符串，最后和get请求一样，利用Handle加载数据。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private void getDataFromPost() &#123;</div><div class="line">        new Thread() &#123;</div><div class="line">            @Override</div><div class="line">            public void run() &#123;</div><div class="line">                super.run();</div><div class="line">                try &#123;</div><div class="line">                    String result = okPost(&quot;http://api.m.mtime.cn/PageSubArea/TrailerList.api&quot;, &quot;&quot;);</div><div class="line">                    Message msg = new Message();</div><div class="line">                    msg.what = POST;</div><div class="line">                    msg.obj = result;</div><div class="line">                    mHandler.sendMessage(msg);</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>post请求结果</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/mw690/b0d9a523jw1fayi3xb134g20bx0mlqv5.gif" alt="post请求结果"></p>
<h1 id="3第三方封装好的OKHttp库————okhttputils"><a href="#3第三方封装好的OKHttp库————okhttputils" class="headerlink" title="3第三方封装好的OKHttp库————okhttputils"></a>3第三方封装好的OKHttp库————okhttputils</h1><h2 id="3-1okhttp-utils简介"><a href="#3-1okhttp-utils简介" class="headerlink" title="3.1okhttp-utils简介"></a>3.1okhttp-utils简介</h2><p>okhttputils是鸿洋大神基于OkHttp3.3.1的一个封装，最新的版本是3.5.0，主要包含有：</p>
<ul>
<li>一般的get请求</li>
<li>一般的post请求</li>
<li>基于Http的文件上传</li>
<li>文件下载</li>
<li>加载图片</li>
<li>支持请求回调，直接返回对象、对象集合</li>
<li>支持session的保持</li>
</ul>
<p>可以参考他这篇文章的博客：<a href="http://blog.csdn.net/lmj623565791/article/details/47911083" target="_blank" rel="external">http://blog.csdn.net/lmj623565791/article/details/47911083</a></p>
<h2 id="3-2下载导入自己的工程"><a href="#3-2下载导入自己的工程" class="headerlink" title="3.2下载导入自己的工程"></a>3.2下载导入自己的工程</h2><p>okhttputils的Github地址：<a href="https://github.com/hongyangAndroid/okhttputils" target="_blank" rel="external">https://github.com/hongyangAndroid/okhttputils</a></p>
<p>将下载好的文件解压后，以库工程的形式导入到 项目中，但会有一些错误。</p>
<h2 id="3-3解决报错"><a href="#3-3解决报错" class="headerlink" title="3.3解决报错"></a>3.3解决报错</h2><h3 id="3-3-1在自己项目的gradle文件中增加如下代码"><a href="#3-3-1在自己项目的gradle文件中增加如下代码" class="headerlink" title="3.3.1在自己项目的gradle文件中增加如下代码"></a>3.3.1在自己项目的gradle文件中增加如下代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">        maven &#123; url &quot;https://www.jitpack.io&quot; &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-3-2把okhttp-utils集成到案例中"><a href="#3-3-2把okhttp-utils集成到案例中" class="headerlink" title="3.3.2把okhttp-utils集成到案例中"></a>3.3.2把okhttp-utils集成到案例中</h3><blockquote>
<p>关联库</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile project(&apos;:okhttputils&apos;)</div></pre></td></tr></table></figure>
<blockquote>
<p>解决报错</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">    testCompile &apos;junit:junit:4.12&apos;</div><div class="line">    compile &apos;com.android.support:appcompat-v7:23.3.0&apos;</div><div class="line">//    compile files(&apos;libs/okhttp-3.4.1.jar&apos;)</div><div class="line">//    compile files(&apos;libs/okio-1.9.0.jar&apos;)</div><div class="line">    compile project(&apos;:okhttputils&apos;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重新运行程序，点击get或者post请求，哇哦，奔溃了，，百思不得其解，一怒之下，删掉了Jar包，然后运行、点击按钮得到了json数据，这一点需要特别注意。</p>
<h2 id="3-4使用okhttp-utils请求文本"><a href="#3-4使用okhttp-utils请求文本" class="headerlink" title="3.4使用okhttp-utils请求文本"></a>3.4使用okhttp-utils请求文本</h2><p>在MainActivity.java中使用原生的OkHttp的get和post方法，这里新建一个HYOkhttpActivity.java类，专门用来使用okhttputils中的方法<br>，布局都很简单，不多说明。</p>
<blockquote>
<p>get请求</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 使用okhttputils的get请求</div><div class="line">     * @param view</div><div class="line">     */</div><div class="line">    public void getDataByOkhttputils(View view) &#123;</div><div class="line">        String url = &quot;http://www.zhiyun-tech.com/App/Rider-M/changelog-zh.txt&quot;;</div><div class="line">        url = &quot;http://api.m.mtime.cn/PageSubArea/TrailerList.api&quot;;</div><div class="line">        OkHttpUtils</div><div class="line">                .get()</div><div class="line">                .url(url)</div><div class="line">                .id(100)</div><div class="line">                .build()</div><div class="line">                .execute(new MyStringCallback());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>MyStringCallback类是一个回调类，继承自okhttputils中的StringCallback类，在这里面处理请求网络前、请求网络后、请求错误、请求成功以及进度的回调，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"> public class MyStringCallback extends StringCallback &#123;</div><div class="line">        @Override</div><div class="line">        public void onBefore(Request request, int id) &#123;</div><div class="line">            setTitle(&quot;loading...&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onAfter(int id) &#123;</div><div class="line">            setTitle(&quot;Sample-okHttp&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onError(Call call, Exception e, int id) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            tv_result.setText(&quot;onError:&quot; + e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onResponse(String response, int id) &#123;</div><div class="line">            Log.e(TAG, &quot;onResponse：complete&quot;);</div><div class="line">            tv_result.setText(&quot;onResponse:&quot; + response);</div><div class="line"></div><div class="line">            switch (id) &#123;</div><div class="line">                case 100:</div><div class="line">                    Toast.makeText(HYOkhttpActivity.this, &quot;http&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">                    break;</div><div class="line">                case 101:</div><div class="line">                    Toast.makeText(HYOkhttpActivity.this, &quot;https&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void inProgress(float progress, long total, int id) &#123;</div><div class="line">            Log.e(TAG, &quot;inProgress:&quot; + progress);</div><div class="line">//            mProgressBar.setProgress((int) (100 * progress));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>运行结果就是在tv_result上加上请求成功的json数据，就不写了。</p>
<blockquote>
<p>post请求</p>
</blockquote>
<p>post请求和get请求一样，只需要把get请求中的get方法换成post方法即可，只是这里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 使用okhttputils的post请求</div><div class="line">     * @param view</div><div class="line">     */</div><div class="line">    public void postDataByOkhttputils(View view) &#123;</div><div class="line">        String url = &quot;http://www.zhiyun-tech.com/App/Rider-M/changelog-zh.txt&quot;;</div><div class="line">        url = &quot;http://api.m.mtime.cn/PageSubArea/TrailerList.api&quot;;</div><div class="line">        OkHttpUtils</div><div class="line">                .post()</div><div class="line">                .url(url)</div><div class="line">                .id(100)</div><div class="line">                .build()</div><div class="line">                .execute(new MyStringCallback());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>运行结果和get请求一样。</p>
<h2 id="3-5使用okhttp-utils下载文件"><a href="#3-5使用okhttp-utils下载文件" class="headerlink" title="3.5使用okhttp-utils下载文件"></a>3.5使用okhttp-utils下载文件</h2><blockquote>
<p>下载文件主要方法，这里下载一个视频</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public void downloadFile(View view)</div><div class="line">   &#123;</div><div class="line">       String url = &quot;http://vfx.mtime.cn/Video/2016/12/14/mp4/161214234616222245.mp4&quot;;</div><div class="line">       OkHttpUtils//</div><div class="line">               .get()//</div><div class="line">               .url(url)//</div><div class="line">               .build()//</div><div class="line">               //下载的文件路径   和  名称</div><div class="line">               .execute(new FileCallBack(Environment.getExternalStorageDirectory().getAbsolutePath(), &quot;okhttp-utils-test.mp4&quot;)//</div><div class="line">               &#123;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onBefore(Request request, int id)</div><div class="line">                   &#123;</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void inProgress(float progress, long total, int id)</div><div class="line">                   &#123;</div><div class="line">                       mProgressBar.setProgress((int) (100 * progress));</div><div class="line">                       //打印进度信息</div><div class="line">                       Log.e(TAG, &quot;inProgress :&quot; + (int) (100 * progress));</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onError(Call call, Exception e, int id)</div><div class="line">                   &#123;</div><div class="line">                       //打印出错的信息</div><div class="line">                       Log.e(TAG, &quot;onError :&quot; + e.getMessage());</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onResponse(File file, int id)</div><div class="line">                   &#123;</div><div class="line">                       //打印下载文件的路径</div><div class="line">                       Log.e(TAG, &quot;onResponse :&quot; + file.getAbsolutePath());</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>进度回调的打印信息如下，下载的文件就在手机根目录，视频是可以播放的。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">E/HYOkhttpActivity: inProgress :0  </div><div class="line"></div><div class="line">省略。。。。</div><div class="line"></div><div class="line">E/HYOkhttpActivity: inProgress :100</div><div class="line"></div><div class="line">E/HYOkhttpActivity: onResponse :/storage/emulated/0/okhttp-utils-test.mp4</div></pre></td></tr></table></figure>
<h2 id="3-6使用okhttp-utils上传文件"><a href="#3-6使用okhttp-utils上传文件" class="headerlink" title="3.6使用okhttp-utils上传文件"></a>3.6使用okhttp-utils上传文件</h2><blockquote>
<p>上传文件的时候调用下面的方法，其中mBaseUrl是自己搭建的本地服务器的地址，这里上传手机存储根目录下的一个code.jpg图片和123.txt图片。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 使用okhttputils 上传多个或者单个文件</div><div class="line">     *</div><div class="line">     * @param view</div><div class="line">     */</div><div class="line">    public void multiFileUpload(View view) &#123;</div><div class="line">        String mBaseUrl = &quot;http://192.168.7.167:8082/FileUpload/FileUploadServlet&quot;;</div><div class="line">        File file = new File(Environment.getExternalStorageDirectory(), &quot;code.jpg&quot;);</div><div class="line">        File file2 = new File(Environment.getExternalStorageDirectory(), &quot;123.txt&quot;);</div><div class="line">        if (!file.exists() || !file2.exists()) &#123;</div><div class="line">            Toast.makeText(HYOkhttpActivity.this, &quot;文件不存在，请修改文件路径&quot;, Toast.LENGTH_SHORT).show();</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</div><div class="line">        params.put(&quot;username&quot;, &quot;bruceChang&quot;);</div><div class="line">        params.put(&quot;password&quot;, &quot;123&quot;);</div><div class="line"></div><div class="line">        String url = mBaseUrl;</div><div class="line">        OkHttpUtils.post()//</div><div class="line">                .addFile(&quot;mFile&quot;, &quot;server_code.jpg&quot;, file)//</div><div class="line">//                .addFile(&quot;mFile&quot;, &quot;123.txt&quot;, file2)//</div><div class="line">                .url(url)</div><div class="line">                .params(params)//</div><div class="line">                .build()//</div><div class="line">                .execute(new MyStringCallback());</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>上传结果，从服务器端可以查看，已经将两个文件上传成功了。</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fazcx0axcvj20bi07aq3y.jpg" alt="上传文件结果"></p>
<h2 id="3-7使用okhttp-utils请求单张图片"><a href="#3-7使用okhttp-utils请求单张图片" class="headerlink" title="3.7使用okhttp-utils请求单张图片"></a>3.7使用okhttp-utils请求单张图片</h2><blockquote>
<p>调用方法，将请求的图片加载到iv_http这个ImageView上，从运行的结果来看，在请求单张图片的时候还是不错的，但在加载列表图片的时候就有问题了。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 使用okhttputils 请求单张图片</div><div class="line">    *</div><div class="line">    * @param view</div><div class="line">    */</div><div class="line">   public void getImage(View view) &#123;</div><div class="line">       tv_result.setText(&quot;&quot;);</div><div class="line">       String url = &quot;http://images.csdn.net/20150817/1.jpg&quot;;</div><div class="line">       OkHttpUtils</div><div class="line">               .get()//</div><div class="line">               .url(url)//</div><div class="line">               .tag(this)//</div><div class="line">               .build()//</div><div class="line">               .connTimeOut(20000)</div><div class="line">               .readTimeOut(20000)</div><div class="line">               .writeTimeOut(20000)</div><div class="line">               .execute(new BitmapCallback() &#123;</div><div class="line">                   @Override</div><div class="line">                   public void onError(Call call, Exception e, int id) &#123;</div><div class="line">                       tv_result.setText(&quot;onError:&quot; + e.getMessage());</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   @Override</div><div class="line">                   public void onResponse(Bitmap bitmap, int id) &#123;</div><div class="line">                       Log.e(&quot;TAG&quot;, &quot;onResponse：complete&quot;);</div><div class="line">                       iv_http.setImageBitmap(bitmap);</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果：</p>
</blockquote>
<p><img src="http://ww2.sinaimg.cn/mw690/b0d9a523jw1fays32vn29g209n0hi444.gif" alt="使用okhttputils 请求单张图片"></p>
<h2 id="3-7使用okhttp-utils请求列表图片"><a href="#3-7使用okhttp-utils请求列表图片" class="headerlink" title="3.7使用okhttp-utils请求列表图片"></a>3.7使用okhttp-utils请求列表图片</h2><blockquote>
<p>既然要在列表中加载图片，就新建一个Activity，使用3.4中的post请求得到返回的数据，利用SharedPreferences存储起来，断网的时候从本地读取数据，调用loadData方法，加载数据。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">if (response != null) &#123;</div><div class="line"></div><div class="line"> CacheUtils.putString(HYOKhttpListActivity.this, url, response);</div><div class="line"> loadData(response);</div><div class="line"></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>loadData加载数据，此方法中需要调用parseData方法来解析数据，这样做到不同功能的方法相互分离，方便调用，HYOkHttpListAdapter也是非常简单的，里面就调用3.6中的方法加载单张图片，最下面有源代码，不懂的可以查看。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 加载数据</div><div class="line">     * @param response</div><div class="line">     */</div><div class="line">    private void loadData(String response) &#123;</div><div class="line">        //得到解析后的收据</div><div class="line">        DataBean dataBean = parseData(response);</div><div class="line">        List&lt;DataBean.ItemData&gt; datas = dataBean.getTrailers();</div><div class="line">        if (datas != null &amp;&amp; datas.size() &gt; 0) &#123;</div><div class="line">            //有数据</div><div class="line">            mHYOkHttpListAdapter = new HYOkHttpListAdapter(HYOKhttpListActivity.this, datas);</div><div class="line">            mListView.setAdapter(mHYOkHttpListAdapter);</div><div class="line">            tv_nodata.setVisibility(View.GONE);</div><div class="line">            //显示适配器</div><div class="line">        &#125; else &#123;</div><div class="line">            ////没有数据</div><div class="line">            tv_nodata.setVisibility(View.VISIBLE);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>当手机没有网络的时候，从本地读取存储的数据，这就需要稍微修改一下3.4中的post请求方法，但或许是OkHttp本身的原因还是okhttputils的原因，没网的时候图片是不能加载出来的。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">     * 使用okhttputils的post请求</div><div class="line">     */</div><div class="line">    public void postDataByOkhttputils() &#123;</div><div class="line">        String cacheValue = CacheUtils.getString(HYOKhttpListActivity.this, url);</div><div class="line">        if (!TextUtils.isEmpty(cacheValue)) &#123;</div><div class="line">            loadData(cacheValue);</div><div class="line">        &#125;</div><div class="line">        OkHttpUtils</div><div class="line">                .post()</div><div class="line">                .url(url)</div><div class="line">                .id(100)</div><div class="line">                .build()</div><div class="line">                .execute(new MyStringCallback());</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>有网的时候结果，可以看到，ListView上面的图片在加载的时候有跳跃，这也是存在的一个问题。</p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/mw690/b0d9a523jw1faz89n9rd8g209n0hihdu.gif" alt="image"></p>
<blockquote>
<p>断开网络结果,图片没有加载出来</p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/mw690/b0d9a523jw1faz8aggl3gg209n0hi7wh.gif" alt="image"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>鸿洋大神的OkHttputils非常详细的介绍了如何使用，但个人认为，要想非常的明白Okhttp的请求，就要明白http协议，不过现如今我们只要会用就行了，以后在慢慢的深入研究学习。</p>
<blockquote>
<p>本项目源码地址：<a href="https://github.com/201216323/TestOkHttpUtils" target="_blank" rel="external">https://github.com/201216323/TestOkHttpUtils</a></p>
<p>最后再附上鸿洋大神okhttp-utils链接地址：<a href="https://github.com/hongyangAndroid/okhttputils" target="_blank" rel="external">https://github.com/hongyangAndroid/okhttputils</a></p>
</blockquote>
<p>欢迎访问<a href="http://www.201216323.tech" target="_blank" rel="external">201216323.tech</a>来查看我的CSDN博客。</p>
<p>欢迎关注我的个人技术公众号,快速查看我的最新文章。</p>
<p><img src="http://img.blog.csdn.net/20161220174646569?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2NnXzIwMTIxNjMyMw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="我的公众号图片" title="bruce常"></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://201216323.tech/2017/09/05/看了你就会的OkHttp（一）/" data-id="cj77mcagq002bacsgyf8rbrlk" class="article-share-link">分享</a><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a href="/2017/09/05/个人收藏的一些很有性价比的Github链接/" class="pre">个人收藏的一些很有性价比的Github链接</a><a href="/2017/09/05/九宫格控件NineGridView/" class="next">九宫格控件NineGridView</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://201216323.tech"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Html5/" style="font-size: 15px;">Html5</a> <a href="/tags/友盟/" style="font-size: 15px;">友盟</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/熟练使用Android-Studio，亲自体验，持续更新。/">熟练使用Android Studio，亲自体验，持续更新。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/MVP设计模式的一次深入探索和优化/">MVP设计模式的一次深入探索和优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-一点一点搞清楚NDK开发的步骤/">JNI开发----一点一点搞清楚NDK开发的步骤</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-复习曾经学习过的C语言/">JNI开发----复习曾经学习过的C语言</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/过去的2016，期待的2017，我与北京继续相伴。/">过去的2016，期待的2017，我与北京继续相伴。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/事件总线之EventBus/">事件总线之EventBus</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Fresco/">图片加载框架之Fresco</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Picasso/">图片加载框架之Picasso</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Glide/">图片加载框架之Glide</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/个人收藏的一些很有性价比的Github链接/">个人收藏的一些很有性价比的Github链接</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">常灿光个人博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>