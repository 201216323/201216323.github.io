<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>图片加载框架之Fresco | 常灿光个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">图片加载框架之Fresco</h1><a id="logo" href="/.">常灿光个人博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">图片加载框架之Fresco</h1><div class="post-meta">Sep 5, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h1 id="1：简介"><a href="#1：简介" class="headerlink" title="1：简介"></a>1：简介</h1><p>Fresco是Facebook最新推出的一款用于Android应用中展示图片的强大图片库，可以从网络、本地存储和本地资源中加载图片。相对于ImageLoader，拥有更快的图片下载速度以及可以加载和显示gif图等诸多优势，是个很好的图片框架。</p>
<h1 id="2：特点"><a href="#2：特点" class="headerlink" title="2：特点"></a>2：特点</h1><h2 id="2-1：内存管理"><a href="#2-1：内存管理" class="headerlink" title="2.1：内存管理"></a>2.1：内存管理</h2><p>在5.0以下系统，Fresco将图片放到一个特别的内存区域。当然，在图片不显示的时候，占用的内存会自动被释放。这会使得APP更加流畅，减少因图片内存占用而引发的OOM。  </p>
<p>内存分配采用：系统匿名共享内存</p>
<h2 id="2-2：渐进式呈现图片"><a href="#2-2：渐进式呈现图片" class="headerlink" title="2.2：渐进式呈现图片"></a>2.2：渐进式呈现图片</h2><p>渐进式图片格式先呈现大致的图片轮廓，然后随着图片下载的继续，呈现逐渐清晰的图片，这对于移动设备，尤其是慢网络有极大的利好，可带来更好的用户体验。</p>
<h2 id="2-3：支持加载Gif图，支持WebP格式"><a href="#2-3：支持加载Gif图，支持WebP格式" class="headerlink" title="2.3：支持加载Gif图，支持WebP格式"></a>2.3：支持加载Gif图，支持WebP格式</h2><h2 id="2-4：图像的呈现"><a href="#2-4：图像的呈现" class="headerlink" title="2.4：图像的呈现"></a>2.4：图像的呈现</h2><ol>
<li>自定义居中焦点(对人脸等图片显示非常有帮助)。</li>
<li>圆角图，当然圆圈也行。</li>
<li>下载失败之后，点击重新下载。</li>
<li>自定义占位图，自定义overlay, 或者进度条。</li>
<li>指定用户按压时的overlay。</li>
</ol>
<h2 id="2-5：图像的加载"><a href="#2-5：图像的加载" class="headerlink" title="2.5：图像的加载"></a>2.5：图像的加载</h2><ol>
<li>为同一个图片指定不同的远程路径，或者使用已经存在本地缓存中的图片。</li>
<li>先显示一个低解析度的图片，等高清图下载完之后再显示高清图。</li>
<li>加载完成回调通知。</li>
<li>对于本地图，如有EXIF缩略图，在大图加载完成之前，可先显示缩略图。</li>
<li>缩放或者旋转图片。</li>
<li>处理已下载的图片。</li>
</ol>
<h1 id="3：下载地址"><a href="#3：下载地址" class="headerlink" title="3：下载地址"></a>3：下载地址</h1><p>Github下载地址是：<a href="https://github.com/facebook/fresco" target="_blank" rel="external">https://github.com/facebook/fresco</a></p>
<p>官方使用网址：<a href="http://fresco-cn.org/docs/index.html" target="_blank" rel="external">http://fresco-cn.org/docs/index.html</a></p>
<p>中文文档地址：<a href="https://www.fresco-cn.org/docs/index.html" target="_blank" rel="external">https://www.fresco-cn.org/docs/index.html</a></p>
<h1 id="4：支持的URI"><a href="#4：支持的URI" class="headerlink" title="4：支持的URI"></a>4：支持的URI</h1><table>
<thead>
<tr>
<th>类型</th>
<th>Scheme</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>远程图片</td>
<td>http://, https://</td>
<td>HttpURLConnection</td>
</tr>
<tr>
<td>本地文件</td>
<td>file://</td>
<td>FileInputStream</td>
</tr>
<tr>
<td>Content provider</td>
<td>content://</td>
<td>ContentResolver</td>
</tr>
<tr>
<td>asset目录下的资源</td>
<td>asset://</td>
<td>AssetManager</td>
</tr>
<tr>
<td>res目录下的资源</td>
<td>res://</td>
<td>Resources.openRawResource</td>
</tr>
</tbody>
</table>
<p>需要注意的是：Fresco中所有的URI都必须是绝对路径，并且带上该URI的scheme </p>
<p>例如，要显示res/drawable下的一张图片可以使用下面的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(&quot;res://aaaaa/&quot;+R.mipmap.pic);</div></pre></td></tr></table></figure>
<p>上面的额”aaaaa”可以使用随意的字符串，不过还是建议使用包名来书写。</p>
<h1 id="5：常用API"><a href="#5：常用API" class="headerlink" title="5：常用API"></a>5：常用API</h1><h2 id="1：宽度不支持wrap-content，-如果要设置宽高比-需要在Java代码中指定setAspectRatio-float-ratio"><a href="#1：宽度不支持wrap-content，-如果要设置宽高比-需要在Java代码中指定setAspectRatio-float-ratio" class="headerlink" title="1：宽度不支持wrap_content， 如果要设置宽高比, 需要在Java代码中指定setAspectRatio(float ratio);"></a>1：宽度不支持wrap_content， 如果要设置宽高比, 需要在Java代码中指定setAspectRatio(float ratio);</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:layout_width=&quot;20dp&quot;</div></pre></td></tr></table></figure>
<h2 id="2：高度不支持wrap-content"><a href="#2：高度不支持wrap-content" class="headerlink" title="2：高度不支持wrap_content"></a>2：高度不支持wrap_content</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:layout_height=&quot;20dp&quot;</div></pre></td></tr></table></figure>
<h2 id="3：下载成功之前显示的图片"><a href="#3：下载成功之前显示的图片" class="headerlink" title="3：下载成功之前显示的图片"></a>3：下载成功之前显示的图片</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:placeholderImage=&quot;@color/wait_color&quot;</div></pre></td></tr></table></figure>
<h2 id="4：设置图片缩放-通常使用focusCrop-该属性值会通过算法把人头像放在中间"><a href="#4：设置图片缩放-通常使用focusCrop-该属性值会通过算法把人头像放在中间" class="headerlink" title="4：设置图片缩放. 通常使用focusCrop,该属性值会通过算法把人头像放在中间"></a>4：设置图片缩放. 通常使用focusCrop,该属性值会通过算法把人头像放在中间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:placeholderImageScaleType=&quot;fitCenter&quot;</div></pre></td></tr></table></figure>
<h2 id="5：加载失败的时候显示的图片"><a href="#5：加载失败的时候显示的图片" class="headerlink" title="5：加载失败的时候显示的图片"></a>5：加载失败的时候显示的图片</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:failureImage=&quot;@drawable/error&quot;</div></pre></td></tr></table></figure>
<h2 id="6：加载失败的时候图片的缩放类型"><a href="#6：加载失败的时候图片的缩放类型" class="headerlink" title="6：加载失败的时候图片的缩放类型"></a>6：加载失败的时候图片的缩放类型</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:failureImageScaleType=“centerInside&quot;</div></pre></td></tr></table></figure>
<h2 id="7：加载失败-提示用户点击重新加载的图片-会覆盖failureImage的图片"><a href="#7：加载失败-提示用户点击重新加载的图片-会覆盖failureImage的图片" class="headerlink" title="7：加载失败,提示用户点击重新加载的图片(会覆盖failureImage的图片)"></a>7：加载失败,提示用户点击重新加载的图片(会覆盖failureImage的图片)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:retryImage=&quot;@drawable/retrying&quot;</div></pre></td></tr></table></figure>
<h2 id="8：设置圆形方式显示图片"><a href="#8：设置圆形方式显示图片" class="headerlink" title="8：设置圆形方式显示图片"></a>8：设置圆形方式显示图片</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fresco:roundAsCircle=&quot;true&quot;</div></pre></td></tr></table></figure>
<h2 id="9：圆角设置"><a href="#9：圆角设置" class="headerlink" title="9：圆角设置"></a>9：圆角设置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fresco:roundedCornerRadius=&quot;1dp&quot;</div><div class="line">fresco:roundTopLeft=&quot;true&quot;</div><div class="line">fresco:roundTopRight=&quot;false&quot;</div><div class="line">fresco:roundBottomLeft=&quot;false&quot;</div><div class="line">fresco:roundBottomRight=&quot;true&quot;</div><div class="line">fresco:roundWithOverlayColor=&quot;@color/corner_color&quot;</div><div class="line">fresco:roundingBorderWidth=&quot;2dp&quot;</div><div class="line">fresco:roundingBorderColor=&quot;@color/border_color&quot;</div></pre></td></tr></table></figure>
<h1 id="6：使用步骤"><a href="#6：使用步骤" class="headerlink" title="6：使用步骤"></a>6：使用步骤</h1><h2 id="6-1：添加依赖"><a href="#6-1：添加依赖" class="headerlink" title="6.1：添加依赖"></a>6.1：添加依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">  // 在 API &lt; 14 上的机器支持 WebP 时，需要添加</div><div class="line">  compile &apos;com.facebook.fresco:animated-base-support:0.14.1&apos;</div><div class="line"></div><div class="line">  // 支持 GIF 动图，需要添加</div><div class="line">  compile &apos;com.facebook.fresco:animated-gif:0.14.1&apos;</div><div class="line"></div><div class="line">  // 支持 WebP （静态图+动图），需要添加</div><div class="line">  compile &apos;com.facebook.fresco:animated-webp:0.14.1&apos;</div><div class="line">  compile &apos;com.facebook.fresco:webpsupport:0.14.1&apos;</div><div class="line"></div><div class="line">  // 仅支持 WebP 静态图，需要添加</div><div class="line">  compile &apos;com.facebook.fresco:webpsupport:0.14.1&apos;</div><div class="line">  // 其他依赖</div><div class="line">  compile &apos;com.facebook.fresco:fresco:0.14.1&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>fresco最新版本是：1.0.0</p>
<h2 id="6-2：在application中初始化Fresco"><a href="#6-2：在application中初始化Fresco" class="headerlink" title="6.2：在application中初始化Fresco"></a>6.2：在application中初始化Fresco</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Fresco.initialize(this);</div></pre></td></tr></table></figure>
<h2 id="6-3：配置网络权限"><a href="#6-3：配置网络权限" class="headerlink" title="6.3：配置网络权限"></a>6.3：配置网络权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</div></pre></td></tr></table></figure>
<h2 id="6-4：在xml布局文件中-加入命名空间"><a href="#6-4：在xml布局文件中-加入命名空间" class="headerlink" title="6.4：在xml布局文件中,加入命名空间"></a>6.4：在xml布局文件中,加入命名空间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 其他元素--&gt;</div><div class="line">&lt;LinearLayout</div><div class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;&gt;</div></pre></td></tr></table></figure>
<h2 id="6-5：在xml中引入SimpleDraweeView"><a href="#6-5：在xml中引入SimpleDraweeView" class="headerlink" title="6.5：在xml中引入SimpleDraweeView"></a>6.5：在xml中引入SimpleDraweeView</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">    android:id=&quot;@+id/my_image_view&quot;</div><div class="line">    android:layout_width=&quot;130dp&quot;</div><div class="line">    android:layout_height=&quot;130dp&quot;</div><div class="line">    fresco:placeholderImage=&quot;@drawable/my_drawable&quot;</div><div class="line">  /&gt;</div></pre></td></tr></table></figure>
<h2 id="6-6：在Java代码中开始加载图片"><a href="#6-6：在Java代码中开始加载图片" class="headerlink" title="6.6：在Java代码中开始加载图片"></a>6.6：在Java代码中开始加载图片</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Uri uri = Uri.parse(&quot;hhttp://p1.so.qhmsg.com/bdr/_240_/t01ffd622bffeabb5e1.jpg&quot;);</div><div class="line">SimpleDraweeView draweeView = (SimpleDraweeView) findViewById(R.id.my_image_view);</div><div class="line">draweeView.setImageURI(uri);</div></pre></td></tr></table></figure>
<h2 id="6-7：注意事项"><a href="#6-7：注意事项" class="headerlink" title="6.7：注意事项"></a>6.7：注意事项</h2><p>如果项目中使用了OkHttp需要进行替换,</p>
<blockquote>
<p>For OkHttp2:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &quot;com.facebook.fresco:imagepipeline-okhttp:0.12.0+&quot;</div></pre></td></tr></table></figure>
<blockquote>
<p>For OkHttp3:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &quot;com.facebook.fresco:imagepipeline-okhttp3:0.12.0+&quot;</div></pre></td></tr></table></figure>
<h1 id="7：例子"><a href="#7：例子" class="headerlink" title="7：例子"></a>7：例子</h1><h2 id="7-1：带进度条的图片"><a href="#7-1：带进度条的图片" class="headerlink" title="7.1：带进度条的图片"></a>7.1：带进度条的图片</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_spimg&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;</div><div class="line">    tools:context=&quot;com.bruce.chang.testfresco.FrescoSpimgActivity&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot;</div><div class="line">        /&gt;</div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_load&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:text=&quot;加载&quot;</div><div class="line">        /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">setTitle(&quot;带进度条的图片&quot;);</div><div class="line">        bt_load.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                // 设置带进度条样式</div><div class="line">                GenericDraweeHierarchyBuilder builder = new GenericDraweeHierarchyBuilder(getResources());</div><div class="line">                GenericDraweeHierarchy hierarchy = builder.setProgressBarImage(new ProgressBarDrawable()).build();</div><div class="line">                sdv_fresco.setHierarchy(hierarchy);</div><div class="line">                Uri uri = Uri.parse(&quot;http://bizhi.zhuoku.com/bizhi/200706/4/20070625/bingbing/012.jpg&quot;);</div><div class="line">                // 设置显示图片</div><div class="line">                sdv_fresco.setImageURI(uri);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>结果，因为布局中设置了placeholderImage，所以会加载一张默认图片</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/mw690/b0d9a523jw1fb4jmachcbg207i0ecacy.gif" alt="image"></p>
<h2 id="7-2：图片的不同裁剪"><a href="#7-2：图片的不同裁剪" class="headerlink" title="7.2：图片的不同裁剪"></a>7.2：图片的不同裁剪</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:gravity=&quot;center_horizontal&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_crop&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:background=&quot;@android:color/black&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line">    &lt;!--裁剪方式的描述信息--&gt;</div><div class="line">    &lt;TextView</div><div class="line">        android:id=&quot;@+id/tv_fresco_explain&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:gravity=&quot;center&quot;</div><div class="line">        android:textSize=&quot;16sp&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;ScrollView</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;&gt;</div><div class="line">        &lt;LinearLayout</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:layout_marginTop=&quot;48dp&quot;</div><div class="line">            android:orientation=&quot;vertical&quot;&gt;</div><div class="line">            &lt;!--9个代表不同裁剪样式的button，这里省略--&gt;</div><div class="line">         </div><div class="line">        &lt;/LinearLayout&gt;</div><div class="line">    &lt;/ScrollView&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码设置</p>
</blockquote>
<ol>
<li>GenericDraweeHierarchyBuilder的初始化</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GenericDraweeHierarchyBuilder builder = new GenericDraweeHierarchyBuilder(getResources());</div></pre></td></tr></table></figure>
<ol>
<li>imageDisplay（加载图片的方法）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//显示图片</div><div class="line">    private void (GenericDraweeHierarchy hierarchy) &#123;</div><div class="line">        sdv_fresco_crop.setHierarchy(hierarchy);</div><div class="line">        Uri uri = Uri.parse(&quot;http://bizhi.zhuoku.com/bizhi/200706/4/20070625/bingbing/012.jpg&quot;);</div><div class="line">        sdv_fresco_crop.setImageURI(uri);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>9个按钮的方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    public void onClick(View view) &#123;</div><div class="line">        switch (view.getId()) &#123;</div><div class="line">            //CENTER</div><div class="line">            case R.id.bt_fresco_center:</div><div class="line">                tv_fresco_explain.setText(&quot;居中，无缩放&quot;);</div><div class="line">                //样式设置</div><div class="line">                GenericDraweeHierarchy hierarchy = builder.setActualImageScaleType(ScalingUtils.ScaleType.CENTER).build();</div><div class="line">                //显示图片</div><div class="line">                imageDisplay(hierarchy);</div><div class="line">                break;</div><div class="line">            //CENTER_CROP</div><div class="line">            case R.id.bt_fresco_centercrop:</div><div class="line">                tv_fresco_explain.setText(&quot;保持宽高比缩小或放大，使得两边都大于或等于显示边界。居中显示&quot;);</div><div class="line">                //样式设置</div><div class="line">                GenericDraweeHierarchy hierarchy1 = builder.setActualImageScaleType(ScalingUtils.ScaleType.CENTER_CROP).build();</div><div class="line">                //显示图片</div><div class="line">                imageDisplay(hierarchy1);</div><div class="line">                break;</div><div class="line">            //FOCUS_CROP</div><div class="line">            case R.id.bt_fresco_focuscrop:</div><div class="line">                tv_fresco_explain.setText(&quot;同centerCrop, 但居中点不是中点，而是指定的某个点,这里我设置为图片的左上角那点&quot;);</div><div class="line">                //设置focusCrop的缩放形式  并指定缩放的中心点在左上角</div><div class="line">                PointF point = new PointF(0f, 0f);</div><div class="line">                //样式设置</div><div class="line">                GenericDraweeHierarchy hierarchy2 = builder.setActualImageScaleType(ScalingUtils.ScaleType.FOCUS_CROP)</div><div class="line">                        .setActualImageFocusPoint(point)</div><div class="line">                        .build();</div><div class="line">                //显示图片</div><div class="line">                imageDisplay(hierarchy2);</div><div class="line">                break;</div><div class="line">            //CENTER_INSIDE</div><div class="line">            case R.id.bt_fresco_centerinside:</div><div class="line">                tv_fresco_explain.setText(&quot;使两边都在显示边界内，居中显示。如果图尺寸大于显示边界，则保持长宽比缩小图片&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy3 = builder.setActualImageScaleType(ScalingUtils.ScaleType.CENTER_INSIDE).build();</div><div class="line">                imageDisplay(hierarchy3);</div><div class="line">                break;</div><div class="line">            //FIT_CENTER</div><div class="line">            case R.id.bt_fresco_fitcenter:</div><div class="line">                tv_fresco_explain.setText(&quot;保持宽高比，缩小或者放大，使得图片完全显示在显示边界内。居中显示&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy4 = builder.setActualImageScaleType(ScalingUtils.ScaleType.FIT_CENTER).build();</div><div class="line">                imageDisplay(hierarchy4);</div><div class="line">                break;</div><div class="line">            //FIT_START</div><div class="line">            case R.id.bt_fresco_fitstart:</div><div class="line">                tv_fresco_explain.setText(&quot;保持宽高比，缩小或者放大，使得图片完全显示在显示边界内，不居中，和显示边界左上对齐&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy5 = builder.setActualImageScaleType(ScalingUtils.ScaleType.FIT_START).build();</div><div class="line">                imageDisplay(hierarchy5);</div><div class="line">                break;</div><div class="line">            //FIT_END</div><div class="line">            case R.id.bt_fresco_fitend:</div><div class="line">                tv_fresco_explain.setText(&quot;保持宽高比，缩小或者放大，使得图片完全显示在显示边界内，不居中，和显示边界右下对齐&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy6 = builder.setActualImageScaleType(ScalingUtils.ScaleType.FIT_END).build();</div><div class="line">                imageDisplay(hierarchy6);</div><div class="line">                break;</div><div class="line">            //FIT_XY</div><div class="line">            case R.id.bt_fresco_fitxy:</div><div class="line">                tv_fresco_explain.setText(&quot;不保持宽高比，填充满显示边界&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy7 = builder.setActualImageScaleType(ScalingUtils.ScaleType.FIT_XY).build();</div><div class="line">                imageDisplay(hierarchy7);</div><div class="line">                break;</div><div class="line">            //null</div><div class="line">            case R.id.bt_fresco_none:</div><div class="line">                tv_fresco_explain.setText(&quot;不设置任何样式&quot;);</div><div class="line">                GenericDraweeHierarchy hierarchy8 = builder.setActualImageScaleType(null).build();</div><div class="line">                imageDisplay(hierarchy8);</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果，因为图片大小的缘故，没有完全演示，自己可以动手试试</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fb4jnws49ng207i0ec42n.gif" alt="image"></p>
<h2 id="7-3：圆形和圆角图片"><a href="#7-3：圆形和圆角图片" class="headerlink" title="7.3：圆形和圆角图片"></a>7.3：圆形和圆角图片</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_circleandcorner&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_circle&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;设置圆形图片&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_corner&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;设置圆角图片&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">uri = Uri.parse(&quot;http://bizhi.zhuoku.com/bizhi/200706/4/20070625/bingbing/012.jpg&quot;);</div><div class="line">         builder = new GenericDraweeHierarchyBuilder(getResources());</div><div class="line"></div><div class="line">        bt_fresco_circle.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                // 参数设置为圆形</div><div class="line">                RoundingParams params = RoundingParams.asCircle();</div><div class="line">                GenericDraweeHierarchy hierarchy = builder.setRoundingParams(params).build();</div><div class="line">                sdv_fresco_circleandcorner.setHierarchy(hierarchy);</div><div class="line">                sdv_fresco_circleandcorner.setImageURI(uri);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        bt_fresco_corner.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                // 配置参数</div><div class="line">                RoundingParams params = RoundingParams.fromCornersRadius(50f);//设置圆角大小</div><div class="line">                params.setOverlayColor(getResources().getColor(android.R.color.holo_blue_light));//覆盖层</div><div class="line">                params.setBorder(getResources().getColor(android.R.color.holo_blue_light), 5);//边框</div><div class="line">//                params.setRoundAsCircle(true);//如果是RoundingParams.fromCornersRadius，这个可以强制进行圆形展示</div><div class="line">                // 设置圆形参数</div><div class="line">                GenericDraweeHierarchy hierarchy = builder.setRoundingParams(params).build();</div><div class="line">                sdv_fresco_circleandcorner.setHierarchy(hierarchy);</div><div class="line">                // 加载图片</div><div class="line">                sdv_fresco_circleandcorner.setImageURI(uri);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww2.sinaimg.cn/mw690/b0d9a523jw1fb4jt0ra0fg208y0gr0vp.gif" alt="image"></p>
<h2 id="7-4：渐进式显示图片"><a href="#7-4：渐进式显示图片" class="headerlink" title="7.4：渐进式显示图片"></a>7.4：渐进式显示图片</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_jpeg&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line">    </div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:id=&quot;@+id/sdv_fresco_jpeg&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/sdv_fresco_askImg&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;请求网络图片&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">builder = new GenericDraweeHierarchyBuilder(getResources());</div><div class="line"></div><div class="line">        sdv_fresco_askImg.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                // 加载质量配置</div><div class="line">                ProgressiveJpegConfig jpegConfig = new ProgressiveJpegConfig() &#123;</div><div class="line">                    @Override</div><div class="line">                    public int getNextScanNumberToDecode(int scanNumber) &#123;</div><div class="line">                        return scanNumber + 2;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public QualityInfo getQualityInfo(int scanNumber) &#123;</div><div class="line">                        boolean isGoodEnough = (scanNumber &gt;= 5);</div><div class="line"></div><div class="line">                        return ImmutableQualityInfo.of(scanNumber, isGoodEnough, false);</div><div class="line">                    &#125;</div><div class="line">                &#125;;</div><div class="line"></div><div class="line">                ImagePipelineConfig.newBuilder(FrescoJianJinShiActivity.this).setProgressiveJpegConfig(jpegConfig).build();</div><div class="line">                // 获取图片URL</div><div class="line">                uri = Uri.parse(&quot;http://bizhi.zhuoku.com/bizhi/200706/4/20070625/bingbing/012.jpg&quot;);</div><div class="line"></div><div class="line">                // 获取图片请求</div><div class="line">                ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri).setProgressiveRenderingEnabled(true).build();</div><div class="line"></div><div class="line">                DraweeController draweeController = Fresco.newDraweeControllerBuilder()</div><div class="line">                        .setImageRequest(request)</div><div class="line">                        .setTapToRetryEnabled(true)</div><div class="line">                        .setOldController(sdv_fresco_jpeg.getController())//使用oldController可以节省不必要的内存分配</div><div class="line">                        .build();</div><div class="line"></div><div class="line">                // 设置加载的控制</div><div class="line">                sdv_fresco_jpeg.setController(draweeController);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/mw690/b0d9a523jw1fb4jzy49frg208y0grwg3.gif" alt="image"></p>
<h2 id="7-5：Gif动画图片"><a href="#7-5：Gif动画图片" class="headerlink" title="7.5：Gif动画图片"></a>7.5：Gif动画图片</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_gif&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_gif&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_askImg&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;请求gif图片&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_stopAnim&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;动画停止&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_startAnim&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;动画开始&quot; /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<ol>
<li>请求Gif图片</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">bt_fresco_askImg.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                // 图片地址</div><div class="line">                Uri uri = Uri.parse(&quot;http://www.sznews.com/humor/attachement/gif/site3/20140902/4487fcd7fc66156f51db5d.gif&quot;);</div><div class="line">                DraweeController controller = Fresco.newDraweeControllerBuilder()</div><div class="line">                        .setUri(uri)</div><div class="line">                        .setAutoPlayAnimations(false)//设置为true将循环播放Gif动画</div><div class="line">                        .setOldController(sdv_fresco_gif.getController())</div><div class="line">                        .build();</div><div class="line"></div><div class="line">                // 设置控制器</div><div class="line">                sdv_fresco_gif.setController(controller);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<ol>
<li>开始动画</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">bt_fresco_startAnim.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                Animatable animation = sdv_fresco_gif.getController().getAnimatable();</div><div class="line"></div><div class="line">                if (animation != null &amp;&amp; !animation.isRunning()) &#123;</div><div class="line">                    animation.start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<ol>
<li>停止动画</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">bt_fresco_stopAnim.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">           @Override</div><div class="line">           public void onClick(View view) &#123;</div><div class="line">               Animatable animation = sdv_fresco_gif.getController().getAnimatable();</div><div class="line"></div><div class="line">               if (animation != null &amp;&amp; animation.isRunning()) &#123;</div><div class="line">                   animation.stop();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>结果（不要忘了在gradle中添加gif的依赖）</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">compile &apos;com.facebook.fresco:animated-gif:0.14.1&apos;</div></pre></td></tr></table></figure>
<p><img src="http://ww4.sinaimg.cn/mw690/b0d9a523jw1fb4k9p0w2bg208y0grqiy.gif" alt="image"></p>
<h2 id="7-6：多图请求以及图片复用"><a href="#7-6：多图请求以及图片复用" class="headerlink" title="7.6：多图请求以及图片复用"></a>7.6：多图请求以及图片复用</h2><blockquote>
<p> 布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_multi&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_multi&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_multiImg&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;先显示低分辨率的图，然后是高分辨率的图&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_multiImg_click&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_thumbnailImg&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;本地缩略图预览&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_thumbnailImg_click&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_multiplexImg&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;本地图片复用&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_multiplexImg_click&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<ol>
<li>先显示低分辨率的图，然后是高分辨率的图</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">void bt_fresco_multiImg_click(View view) &#123;</div><div class="line">        //同一张图片，不同品质的两个uri</div><div class="line">        Uri lowResUri = Uri.parse(&quot;http://img1.gamedog.cn/2012/03/11/19-120311133617-50.jpg&quot;);</div><div class="line">        Uri highResUri = Uri.parse(&quot;http://img5.duitang.com/uploads/item/201312/03/20131203153823_Y4y8F.jpeg&quot;);</div><div class="line">        DraweeController controller = Fresco.newDraweeControllerBuilder()</div><div class="line">                .setLowResImageRequest(ImageRequest.fromUri(lowResUri))</div><div class="line">                .setImageRequest(ImageRequest.fromUri(highResUri))</div><div class="line">                .setOldController(sdv_fresco_multi.getController())</div><div class="line">                .build();</div><div class="line">        sdv_fresco_multi.setController(controller);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>本地缩略图预览</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">void bt_fresco_thumbnailImg_click(View view)&#123;</div><div class="line"></div><div class="line">        //将本地图片地址转换成Uri</div><div class="line">        Uri uri = Uri.fromFile(new File(Environment.getExternalStorageDirectory()+&quot;/swj.jpg&quot;));</div><div class="line">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri)</div><div class="line">                .setLocalThumbnailPreviewsEnabled(true)</div><div class="line">                .build();</div><div class="line">        DraweeController controller = Fresco.newDraweeControllerBuilder()</div><div class="line">                .setImageRequest(request)</div><div class="line">                .setOldController(sdv_fresco_multi.getController())</div><div class="line">                .build();</div><div class="line">        sdv_fresco_multi.setController(controller);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>本地图片复用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">void bt_fresco_multiplexImg_click(View view)&#123;</div><div class="line"></div><div class="line">        //本地图片的复用</div><div class="line">        //在请求之前，还会去内存中请求一次图片，没有才会先去本地，最后去网络uri</div><div class="line"></div><div class="line">        //本地准备复用图片的uri  如果本地这个图片不存在，会自动去加载下一个uri</div><div class="line">        Uri uri1 = Uri.fromFile(new File(Environment.getExternalStorageDirectory()+&quot;/swj.jpg&quot;));</div><div class="line">        //图片的网络uri</div><div class="line">        Uri uri2 = Uri.parse(&quot;http://img5.duitang.com/uploads/item/201312/03/20131203153823_Y4y8F.jpeg&quot;);</div><div class="line">        ImageRequest request1 = ImageRequest.fromUri(uri1);</div><div class="line">        ImageRequest request2 = ImageRequest.fromUri(uri2);</div><div class="line">        ImageRequest[] requests = &#123;request1, request2&#125;;</div><div class="line">        DraweeController controller = Fresco.newDraweeControllerBuilder()</div><div class="line">                .setFirstAvailableImageRequests(requests)</div><div class="line">                .setOldController(sdv_fresco_multi.getController())</div><div class="line">                .build();</div><div class="line">        sdv_fresco_multi.setController(controller);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww2.sinaimg.cn/mw690/b0d9a523jw1fb4kp5ea49g208y0gr780.gif" alt="image"></p>
<h2 id="7-7：图片加载监听"><a href="#7-7：图片加载监听" class="headerlink" title="7.7：图片加载监听"></a>7.7：图片加载监听</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_listener&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:id=&quot;@+id/sdv_fresco_listener&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_listener&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;开始加载图片&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_listener_click&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    &lt;TextView</div><div class="line">        android:id=&quot;@+id/tv_fresco_listener&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:textColor=&quot;@android:color/black&quot;</div><div class="line">        android:textSize=&quot;14sp&quot;</div><div class="line">        android:text=&quot;tv_fresco_listener&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    &lt;TextView</div><div class="line">        android:id=&quot;@+id/tv_fresco_listener2&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:textColor=&quot;@android:color/black&quot;</div><div class="line">        android:textSize=&quot;14sp&quot;</div><div class="line">        android:text=&quot;tv_fresco_listener2&quot;</div><div class="line">        /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<ol>
<li>自定义BaseControllerListener初始化</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">//对所有的图片加载，onFinalImageSet 或者 onFailure 都会被触发。前者在成功时，后者在失败时。</div><div class="line">    //如果允许呈现渐进式JPEG，同时图片也是渐进式图片，onIntermediateImageSet会在每个扫描被解码后回调。</div><div class="line">    // 具体图片的那个扫描会被解码，参见渐进式JPEG图</div><div class="line">    private ControllerListener controllerListener = new BaseControllerListener&lt;ImageInfo&gt;() &#123;</div><div class="line">        @Override</div><div class="line">        public void onFinalImageSet(String id, ImageInfo imageInfo, Animatable animatable) &#123;</div><div class="line">           //前者在成功时</div><div class="line">            super.onFinalImageSet(id, imageInfo, animatable);</div><div class="line"></div><div class="line">            if (imageInfo == null) &#123;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            QualityInfo qualityInfo = imageInfo.getQualityInfo();</div><div class="line"></div><div class="line">            tv_fresco_listener.setText(&quot;Final image received! &quot; +</div><div class="line">                    &quot;\nSize: &quot; + imageInfo.getWidth()</div><div class="line">                    + &quot;x&quot; + imageInfo.getHeight()</div><div class="line">                    + &quot;\nQuality level: &quot; + qualityInfo.getQuality()</div><div class="line">                    + &quot;\ngood enough: &quot; + qualityInfo.isOfGoodEnoughQuality()</div><div class="line">                    + &quot;\nfull quality: &quot; + qualityInfo.isOfFullQuality());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public void onIntermediateImageSet(String id, ImageInfo imageInfo) &#123;</div><div class="line">            super.onIntermediateImageSet(id, imageInfo);</div><div class="line"></div><div class="line">            tv_fresco_listener2.setText(&quot;IntermediateImageSet image receiced&quot;);</div><div class="line">        &#125;</div><div class="line">        //后者在失败时</div><div class="line">        @Override</div><div class="line">        public void onFailure(String id, Throwable throwable) &#123;</div><div class="line">            super.onFailure(id, throwable);</div><div class="line"></div><div class="line">            tv_fresco_listener.setText(&quot;Error loading&quot; + id);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<ol>
<li>开始加载图片按钮方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">void bt_fresco_listener_click(View view) &#123;</div><div class="line"></div><div class="line">        ProgressiveJpegConfig jpegConfig = new ProgressiveJpegConfig() &#123;</div><div class="line">            @Override</div><div class="line">            public int getNextScanNumberToDecode(int scanNumber) &#123;</div><div class="line">                return scanNumber + 2;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            public QualityInfo getQualityInfo(int scanNumber) &#123;</div><div class="line">                boolean isGoodEnough = (scanNumber &gt;= 5);</div><div class="line"></div><div class="line">                return ImmutableQualityInfo.of(scanNumber, isGoodEnough, false);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        ImagePipelineConfig.newBuilder(this).setProgressiveJpegConfig(jpegConfig).build();</div><div class="line">        Uri uri = Uri.parse(&quot;http://h.hiphotos.baidu.com/zhidao/pic/item/58ee3d6d55fbb2fbac4f2af24f4a20a44723dcee.jpg&quot;);</div><div class="line">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri).setProgressiveRenderingEnabled(true).build();</div><div class="line"></div><div class="line">        DraweeController controller = Fresco.newDraweeControllerBuilder()</div><div class="line">                .setOldController(sdv_fresco_listener.getController())</div><div class="line">                .setImageRequest(request)</div><div class="line">                //设置监听器监听图片加载状态</div><div class="line">                .setControllerListener(controllerListener)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        sdv_fresco_listener.setController(controller);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果,加载成功的时候可以得到图片的相关信息，如Size，在浏览器中查看，该图片的尺寸就是那么大的。</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fb4l73xynyg208y0grgo6.gif" alt="image"></p>
<h2 id="7-8：图片缩放和旋转"><a href="#7-8：图片缩放和旋转" class="headerlink" title="7.8：图片缩放和旋转"></a>7.8：图片缩放和旋转</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_resize&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_resize&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_resize&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_resize_click&quot;</div><div class="line">        android:text=&quot;修内存中改图片大小&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_rotate&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_rotate_click&quot;</div><div class="line">        android:text=&quot;旋转图片&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">//缩放</div><div class="line">    void bt_fresco_resize_click(View view) &#123;</div><div class="line"></div><div class="line">        int width = 50;</div><div class="line">        int height = 50;</div><div class="line">        Uri uri = Uri.parse(&quot;http://c.hiphotos.baidu.com/image/pic/item/962bd40735fae6cd21a519680db30f2442a70fa1.jpg&quot;);</div><div class="line">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri)</div><div class="line">                .setResizeOptions(new ResizeOptions(width, height)).build();</div><div class="line">        PipelineDraweeController controller = (PipelineDraweeController) Fresco.newDraweeControllerBuilder()</div><div class="line">                .setOldController(sdv_fresco_resize.getController())</div><div class="line">                .setImageRequest(request)</div><div class="line">                .build();</div><div class="line">        sdv_fresco_resize.setController(controller);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //旋转</div><div class="line">    void bt_fresco_rotate_click(View view) &#123;</div><div class="line">        Uri uri2 = Uri.parse(&quot;http://c.hiphotos.baidu.com/image/pic/item/962bd40735fae6cd21a519680db30f2442a70fa1.jpg&quot;);</div><div class="line">        RotationOptions rotationOptions = RotationOptions.forceRotation(RotationOptions.ROTATE_90);</div><div class="line">        ImageRequest request1 = ImageRequestBuilder.newBuilderWithSource(uri2)</div><div class="line">                .setRotationOptions(RotationOptions.autoRotate())</div><div class="line">                .setRotationOptions(rotationOptions)//旋转的时候要使用RotationOptions类</div><div class="line">                .build();//但貌似Fresco在旋转的功能上不是很好</div><div class="line">        DraweeController controller1 = Fresco.newDraweeControllerBuilder()</div><div class="line">                .setImageRequest(request1)</div><div class="line">                .setOldController(sdv_fresco_resize.getController()).build();</div><div class="line">        sdv_fresco_resize.setController(controller1);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fb50aeo8y6g208y0grwke.gif" alt="image"></p>
<h2 id="7-9：修改图片"><a href="#7-9：修改图片" class="headerlink" title="7.9：修改图片"></a>7.9：修改图片</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:fresco=&quot;http://schemas.android.com/apk/res-auto&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_modify&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;com.facebook.drawee.view.SimpleDraweeView</div><div class="line">        android:id=&quot;@+id/sdv_fresco_modify&quot;</div><div class="line">        android:layout_width=&quot;150dp&quot;</div><div class="line">        android:layout_height=&quot;150dp&quot;</div><div class="line">        android:layout_gravity=&quot;center&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        fresco:placeholderImage=&quot;@mipmap/fbb&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_modify&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;48dp&quot;</div><div class="line">        android:text=&quot;为图片添加网格&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_modify_click&quot;</div><div class="line">        /&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">void bt_fresco_modify_click(View view)&#123;</div><div class="line"></div><div class="line">        Uri uri = Uri.parse(&quot;http://c.hiphotos.baidu.com/image/pic/item/962bd40735fae6cd21a519680db30f2442a70fa1.jpg&quot;);</div><div class="line"></div><div class="line">        Postprocessor redMeshPostprocessor = new BasePostprocessor() &#123;</div><div class="line">            @Override</div><div class="line">            public String getName() &#123;</div><div class="line">                return &quot;redMeshPostprocessor&quot;;</div><div class="line">            &#125;</div><div class="line">            //绘制红色点状网格</div><div class="line">            @Override</div><div class="line">            public void process(Bitmap bitmap) &#123;</div><div class="line"></div><div class="line">                for (int x = 0; x &lt; bitmap.getWidth(); x += 2) &#123;</div><div class="line"></div><div class="line">                    for (int y = 0; y &lt; bitmap.getHeight(); y += 2) &#123;</div><div class="line">                        bitmap.setPixel(x, y, Color.RED);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri)</div><div class="line">                .setPostprocessor(redMeshPostprocessor)</div><div class="line">                .build();</div><div class="line">        PipelineDraweeController controller = (PipelineDraweeController)</div><div class="line">                Fresco.newDraweeControllerBuilder()</div><div class="line">                        .setImageRequest(request)</div><div class="line">                        .setOldController(sdv_fresco_modify.getController())</div><div class="line">                        .build();</div><div class="line">        sdv_fresco_modify.setController(controller);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/b0d9a523jw1fb509ax122g208y0gr0y7.gif" alt="image"></p>
<h2 id="7-10："><a href="#7-10：" class="headerlink" title="7.10："></a>7.10：</h2><blockquote>
<p>布局</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</div><div class="line">    android:id=&quot;@+id/activity_fresco_auto_size&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot;</div><div class="line">    android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line"></div><div class="line">    &lt;Button</div><div class="line">        android:id=&quot;@+id/bt_fresco_loadsmall&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:text=&quot;加载图片&quot;</div><div class="line">        android:onClick=&quot;bt_fresco_loadsmall_click&quot;</div><div class="line">        /&gt;</div><div class="line"></div><div class="line">    &lt;LinearLayout</div><div class="line">        android:id=&quot;@+id/ll_fresco&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;wrap_content&quot;</div><div class="line">        android:layout_marginTop=&quot;8dp&quot;</div><div class="line">        android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">    &lt;/LinearLayout&gt;</div><div class="line">&lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_fresco_dynamic_display_img);</div><div class="line">        ll_fresco = (LinearLayout) findViewById(R.id.ll_fresco);</div><div class="line">        setTitle(&quot;动态展示图片&quot;);</div><div class="line"></div><div class="line">        simpleDraweeView = new SimpleDraweeView(this);</div><div class="line">        //设置宽高比</div><div class="line">        simpleDraweeView.setAspectRatio(1.0f);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void bt_fresco_loadsmall_click(View view) &#123;</div><div class="line"></div><div class="line">        final Uri uri = Uri.parse(&quot;http://img4q.duitang.com/uploads/item/201304/27/20130427043538_wAfHC.jpeg&quot;);</div><div class="line"></div><div class="line">        ImageRequest request = ImageRequestBuilder.newBuilderWithSource(uri)</div><div class="line">                .build();</div><div class="line"></div><div class="line">        PipelineDraweeController controller = (PipelineDraweeController)</div><div class="line">                Fresco.newDraweeControllerBuilder()</div><div class="line">                        .setImageRequest(request)</div><div class="line">                        .setOldController(simpleDraweeView.getController())</div><div class="line">                        .build();</div><div class="line">        simpleDraweeView.setController(controller);</div><div class="line">        ll_fresco.addView(simpleDraweeView);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="http://ww2.sinaimg.cn/mw690/b0d9a523jw1fb5085lt7bg208y0grn0m.gif" alt="image"></p>
<h1 id="8：注意事项"><a href="#8：注意事项" class="headerlink" title="8：注意事项"></a>8：注意事项</h1><h2 id="8-1：问题处理"><a href="#8-1：问题处理" class="headerlink" title="8.1：问题处理"></a>8.1：问题处理</h2><ol>
<li>重复的边界</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这是使用圆角的一个缺陷。 参考圆角和圆圈 来获取更多信息。</div></pre></td></tr></table></figure>
<ol>
<li>图片没有加载</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">你可以从 image pipeline 打出的日志来查看原因。 这里提供一些通常会导致问题的原因:</div></pre></td></tr></table></figure>
<ol>
<li>文件不可用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">无效的路径、链接会导致这种情况。</div><div class="line">判断网络链接是否有效，你可以尝试在浏览器中打开它，看看是否图片会被加载。若图片依然加载不出来，那么这不是Fresco的问题。</div><div class="line">判断本地文件是否有效，你可以通过下面这段代码来校验：</div><div class="line"></div><div class="line">FileInputStream fis = new FileInputStream(new File(localUri.getPath()));</div><div class="line"></div><div class="line">如果这里抛出了异常，那么这不是Fresco的问题，可能是你的其他代码导致的。有可能是没有获取到SD卡读取权限、路径不合法、文件不存在等。</div></pre></td></tr></table></figure>
<ol>
<li>OOM - 无法分配图片空间</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">加载特别特别大的图片时最容易导致这种情况。</div><div class="line">如果你加载的图片比承载的View明显大出太多，那你应该考虑将它Resize一下。</div></pre></td></tr></table></figure>
<ol>
<li>Bitmap太大导致无法绘制</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Android 无法绘制长或宽大于2048像素的图片。</div><div class="line">这是由OpenGL渲染系统限制的，如果它超过了这个界限，Fresco会对它进行Resize。</div></pre></td></tr></table></figure>
<ol>
<li>通过Logcat来判断原因</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">在加载图片时会出现各种各样的原因导致加载失败。</div><div class="line">在使用Fresco的时候，最直接的方式就是查看 image pipeline 打出的VERBOSE级别日志。</div></pre></td></tr></table></figure>
<ol>
<li>启动日志</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">默认情况下Fresco是关闭日志输出的，你可以配置image pipeline让它启动.</div><div class="line"></div><div class="line">Set&lt;RequestListener&gt; requestListeners = new HashSet&lt;&gt;();</div><div class="line">requestListeners.add(new RequestLoggingListener());</div><div class="line">ImagePipelineConfig config = ImagePipelineConfig.newBuilder(context)</div><div class="line">   // other setters</div><div class="line">   .setRequestListeners(requestListeners)</div><div class="line">   .build();</div><div class="line">Fresco.initialize(context, config);</div><div class="line">FLog.setMinimumLoggingLevel(FLog.VERBOSE);</div></pre></td></tr></table></figure>
<ol>
<li>查看日志</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">你可以通过下面这条shell命令来查看Fresco日志：</div><div class="line"></div><div class="line">adb logcat -v threadtime | grep -iE &apos;LoggingListener|AbstractDraweeController|BufferedDiskCache&apos;</div><div class="line"></div><div class="line">它的输出为如下格式：</div><div class="line">08-12 09:11:14.792 6690 6734 V unknown:RequestLoggingListener: time 11201792: onProducerStart: &#123;requestId: 1, producer: EncodedMemoryCacheProducer&#125;</div><div class="line">08-12 09:11:14.792 6690 6734 V unknown:RequestLoggingListener: time 11201792: onProducerFinishWithSuccess: &#123;requestId: 1, producer: EncodedMemoryCacheProducer, elapsedTime: 0 ms, extraMap: &#123;cached_value_found=false&#125;&#125;</div><div class="line">08-12 09:11:14.792 6690 6734 V unknown:RequestLoggingListener: time 11201792: onProducerStart: &#123;requestId: 1, producer: DiskCacheProducer&#125;</div><div class="line">08-12 09:11:14.792 6690 6735 V unknown:BufferedDiskCache: Did not find image for http://www.example.com/image.jpg in staging area</div><div class="line">08-12 09:11:14.793 6690 6735 V unknown:BufferedDiskCache: Disk cache read for http://www.example.com/image.jpg</div><div class="line">08-12 09:11:14.793 6690 6735 V unknown:BufferedDiskCache: Disk cache miss for http://www.example.com/image.jpg</div><div class="line">08-12 09:11:14.793 6690 6735 V unknown:RequestLoggingListener: time 11201793: onProducerFinishWithSuccess: &#123;requestId: 1, producer: DiskCacheProducer, elapsedTime: 1 ms, extraMap: &#123;cached_value_found=false&#125;&#125;</div><div class="line">08-12 09:11:14.793 6690 6735 V unknown:RequestLoggingListener: time 11201793: onProducerStart: &#123;requestId: 1, producer: NetworkFetchProducer&#125;</div><div class="line">08-12 09:11:15.161 6690 7358 V unknown:RequestLoggingListener: time 11202161: onProducerFinishWithSuccess: &#123;requestId: 1, producer: NetworkFetchProducer, elapsedTime: 368 ms, extraMap: null&#125;</div><div class="line">08-12 09:11:15.162 6690 6742 V unknown:BufferedDiskCache: About to write to disk-cache for key http://www.example.com/image.jpg</div><div class="line">08-12 09:11:15.162 6690 6734 V unknown:RequestLoggingListener: time 11202162: onProducerStart: &#123;requestId: 1, producer: DecodeProducer&#125;</div><div class="line">08-12 09:11:15.163 6690 6742 V unknown:BufferedDiskCache: Successful disk-cache write for key http://www.example.com/image.jpg</div><div class="line">08-12 09:11:15.169 6690 6734 V unknown:RequestLoggingListener: time 11202169: onProducerFinishWithSuccess: &#123;requestId: 1, producer: DecodeProducer, elapsedTime: 7 ms, extraMap: &#123;hasGoodQuality=true, queueTime=0, bitmapSize=600x400, isFinal=true&#125;&#125;</div><div class="line">08-12 09:11:15.169 6690 6734 V unknown:RequestLoggingListener: time 11202169: onRequestSuccess: &#123;requestId: 1, elapsedTime: 378 ms&#125;</div><div class="line">08-12 09:11:15.184 6690 6690 V unknown:AbstractDraweeController: controller 28ebe0eb 1: set_final_result @ onNewResult: image: CloseableReference 2fd41bb0</div><div class="line"></div><div class="line">在这个示例中，我们发现名为28ebe0eb的 DraweeView 向名为36e95857的 DataSource 进行了图像请求。</div><div class="line">首先，图片没有在内存缓存中找到，也没有在磁盘缓存中找到，最后去网络上下载图片。下载成功后，图片被解码，之后请求结束。</div><div class="line">最后数据源通知 controller 图片就绪，显示图片(set_final_result）。</div></pre></td></tr></table></figure>
<h2 id="8-2：一些陷阱"><a href="#8-2：一些陷阱" class="headerlink" title="8.2：一些陷阱"></a>8.2：一些陷阱</h2><ol>
<li>不要使用 ScrollViews界</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">如果你想要在一个长的图片列表中滑动，你应该使用 RecyclerView，ListView，或 GridView。这三者都会在你滑动时不断重用子视图。Fresco 的 view 会接收系统事件，使它们能正确管理内存。</div><div class="line">ScrollView 不会这样做。因此，Fresco view 不会被告知它们是否在屏幕上显示，并保持图片内存占用直到你的 Fragment 或 Activity 停止。</div><div class="line">你的 App 将会面临更大的 OOM 风险。</div></pre></td></tr></table></figure>
<ol>
<li>不要向下转换</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">不要试图把Fresco返回的一些对象进行向下转化，这也许会带来一些对象操作上的便利</div><div class="line">，但是也许在后续的版本中，你会遇到一些因为向下转换特性丢失导致的难以处理的问题。</div></pre></td></tr></table></figure>
<ol>
<li>不要使用getTopLevelDrawable</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DraweeHierarchy.getTopLevelDrawable() 仅仅 应该在DraweeViews中用，除了定义View中，其他应用代码建议连碰都不要碰这个。</div><div class="line"></div><div class="line">在自定义view中，也千万不要将返回值向下转换，也许下个版本，我们会更改这个返回值类型。</div></pre></td></tr></table></figure>
<ol>
<li>不要复用 DraweeHierarchies</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">永远不要把 DraweeHierarchy 通过 DraweeView.setHierarchy 设置给不同的View。</div><div class="line">DraweeHierarchy 是由一系列 Drawable 组成的。在 Android 中, Drawable 不能被多个 View 共享。</div></pre></td></tr></table></figure>
<ol>
<li>不要在多个DraweeHierarchy中使用同一个Drawable</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">原因同上。不过你可以在占位图、重试图、错误图中使用相同的资源ID，Android 实际会创建不同的 Drawable。</div><div class="line"></div><div class="line">如果你使用GenericDraweeHierarchyBuilder，那么需要调用Resources.getDrawable来通过资源获取图片。</div><div class="line"></div><div class="line">不过请不要只调用一次然后将结果传给不同的Hierarchy！</div></pre></td></tr></table></figure>
<ol>
<li>不要直接控制 hierarchy</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">不要直接使用 SettableDraweeHierarchy 方法(reset，setImage，…)。</div><div class="line"></div><div class="line">它们应该仅由 controller 使用。</div><div class="line"></div><div class="line">不要使用setControllerOverlay来设置一个覆盖图，这个方法只能给 controller 调用。</div><div class="line">如果你需要显示覆盖图，可以参考Drawee的各种效果配置</div></pre></td></tr></table></figure>
<ol>
<li>不要直接给 DraweeView 设置图片</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">目前 DraweeView 直接继承于 ImageView，因此它有 setImageBitmap,</div><div class="line">setImageDrawable 等方法。</div><div class="line">如果利用这些方法直接设置一张图片，内部的 DraweeHierarchy 就会丢失，也就无法取到image</div><div class="line">pipeline 的任何图像了。</div></pre></td></tr></table></figure>
<ol>
<li>使用 DraweeView 时，请不要使用任何 ImageView 的属性</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">在后续的版本中，DraweeView 会直接从 View 派生。</div><div class="line">任何属于 ImageView 但是不属于 View 的方法都会被移除。</div></pre></td></tr></table></figure>
<h2 id="8-3：为什么不支持wrap-content"><a href="#8-3：为什么不支持wrap-content" class="headerlink" title="8.3：为什么不支持wrap_content"></a>8.3：为什么不支持wrap_content</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">人们经常会问，为什么Fresco中不可以使用wrap_content？</div><div class="line"></div><div class="line">主要的原因是，Drawee永远会在getIntrinsicHeight/getIntrinsicWidth中返回-1。</div><div class="line">这么做的原因是 Drawee 不像ImageView一样。它同一时刻可能会显示多个元素。比如在从占位图渐变到目标图</div><div class="line">时，两张图会有同时显示的时候。再比如可能有多张目标图片（低清晰度、高清晰度两张）。如果这些图像都是不同的尺寸，那么很难定义”intrinsic”尺寸。</div><div class="line"></div><div class="line">如果我们要先用占位图的尺寸，等加载完成后再使用真实图的尺寸，那么图片很可能显</div><div class="line">示错误。它可能会被根据占位图的尺寸来缩放、裁剪。</div><div class="line">唯一防止这种事情的方式就只有在图片加载完成后强制触发一次layout。这样的话不仅</div><div class="line">会影响性能，而且会让应用的界面突变，很影响用户体验！</div><div class="line">如果用户正在读一篇文章，然后在图片加载完成后整篇文章突然向下移动，这是非常不好的。</div><div class="line"></div><div class="line">所以你必须指定尺寸或者用match_parent来布局。</div><div class="line"></div><div class="line">你如果从服务端请求图片，服务端可以做到返回图片尺寸。然后你拿到之后通过setLayoutParams 来给View设置宽高。</div><div class="line"></div><div class="line">当然如果你必须要使用wrap_content，那么你可以参考StackOverflow上的一个回答。</div><div class="line">但是我们以后会移除这个功能，Ugly things should look ugly。</div></pre></td></tr></table></figure>
<h2 id="8-4：共享元素动画"><a href="#8-4：共享元素动画" class="headerlink" title="8.4：共享元素动画"></a>8.4：共享元素动画</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">使用 ChangeBounds，而不是ChangeImageTransform</div><div class="line"></div><div class="line">Android 5.0 (Lollipop) 引入了 共享元素动画，允许在多个Activity切换时共享相同的View！</div><div class="line"></div><div class="line">你可以在XML中定义这个变换。有个ChangeImageTransform变换可以在共享元素切换时对ImageView进行变换，可惜Fresco暂时不支持它，因为Drawee维护着自己的转换Matrix。</div><div class="line"></div><div class="line">幸运的是你可以有另一种做法：使用ChangeBounds。你可以改变layout的边界，这样Fresco会根据它进行自适应，也能够达到你想要的功能。</div></pre></td></tr></table></figure>
<h1 id="9：总结"><a href="#9：总结" class="headerlink" title="9：总结"></a>9：总结</h1><p>Fresco的使用在一定程度上要比Picasso、GLide要复杂，但是在强大的Fresco面前，复杂并不是理由，只要灵活的使用Fresco，一定会给我们的开发带来便利。</p>
<p>有关Fresco的任何问题可以查看Fresco的中文API网址来寻求解决方案。</p>
<p><a href="https://www.fresco-cn.org/docs/index.html" target="_blank" rel="external">https://www.fresco-cn.org/docs/index.html</a></p>
<blockquote>
<p>欢迎访问<a href="http://www.201216323.tech" target="_blank" rel="external">201216323.tech</a>来查看我的CSDN博客。</p>
<p>欢迎关注我的个人技术公众号,快速查看我的最新文章。</p>
</blockquote>
<p><img src="http://img.blog.csdn.net/20161220174646569?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2NnXzIwMTIxNjMyMw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="我的公众号图片" title="bruce常"></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://201216323.tech/2017/09/05/图片加载框架之Fresco/" data-id="cj77mcaga0025acsgd6q8k9hz" class="article-share-link">分享</a><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-nav"><a href="/2017/09/05/事件总线之EventBus/" class="pre">事件总线之EventBus</a><a href="/2017/09/05/图片加载框架之Picasso/" class="next">图片加载框架之Picasso</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://201216323.tech"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Html5/" style="font-size: 15px;">Html5</a> <a href="/tags/友盟/" style="font-size: 15px;">友盟</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/熟练使用Android-Studio，亲自体验，持续更新。/">熟练使用Android Studio，亲自体验，持续更新。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/MVP设计模式的一次深入探索和优化/">MVP设计模式的一次深入探索和优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-一点一点搞清楚NDK开发的步骤/">JNI开发----一点一点搞清楚NDK开发的步骤</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/JNI开发-复习曾经学习过的C语言/">JNI开发----复习曾经学习过的C语言</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/过去的2016，期待的2017，我与北京继续相伴。/">过去的2016，期待的2017，我与北京继续相伴。</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/事件总线之EventBus/">事件总线之EventBus</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Fresco/">图片加载框架之Fresco</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Picasso/">图片加载框架之Picasso</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/图片加载框架之Glide/">图片加载框架之Glide</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/05/个人收藏的一些很有性价比的Github链接/">个人收藏的一些很有性价比的Github链接</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">常灿光个人博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>